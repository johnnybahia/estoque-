<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Gest√£o de Estoque</title>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --success-color: #27ae60;
      --warning-color: #f39c12;
      --danger-color: #e74c3c;
      --light-bg: #ecf0f1;
      --white: #ffffff;
      --text-dark: #2c3e50;
      --border-color: #bdc3c7;
      --sidebar-width: 250px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--light-bg);
      color: var(--text-dark);
      line-height: 1.6;
    }

    /* Header */
    .header {
      background: var(--primary-color);
      color: var(--white);
      padding: 1rem 2rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }

    .header h1 {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .header .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .header .user-info span {
      font-size: 0.9rem;
    }

    .header .logout-btn {
      background: var(--danger-color);
      color: var(--white);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s;
    }

    .header .logout-btn:hover {
      background: #c0392b;
    }

    /* Layout Container */
    .container {
      display: flex;
      margin-top: 60px;
      min-height: calc(100vh - 60px);
    }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--white);
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      overflow-y: auto;
      position: fixed;
      left: 0;
      top: 60px;
      bottom: 0;
      transition: transform 0.3s;
    }

    .sidebar.hidden {
      transform: translateX(-100%);
    }

    .sidebar-toggle {
      display: block;
      position: fixed;
      top: 70px;
      left: 10px;
      z-index: 999;
      background: var(--secondary-color);
      color: var(--white);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      transition: left 0.3s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .sidebar-toggle:hover {
      background: #2980b9;
    }

    .sidebar-toggle.shifted {
      left: 260px;
    }

    .sidebar nav ul {
      list-style: none;
      padding: 1rem 0;
    }

    .sidebar nav li {
      margin: 0;
    }

    .sidebar nav a {
      display: flex;
      align-items: center;
      padding: 0.9rem 1.5rem;
      color: var(--text-dark);
      text-decoration: none;
      transition: background 0.3s, color 0.3s;
      border-left: 3px solid transparent;
      gap: 0.8rem;
    }

    .sidebar nav a:hover {
      background: var(--light-bg);
      border-left-color: var(--secondary-color);
    }

    .sidebar nav a.active {
      background: var(--light-bg);
      border-left-color: var(--secondary-color);
      color: var(--secondary-color);
      font-weight: 600;
    }

    .sidebar nav .separator {
      border-bottom: 1px solid var(--border-color);
      margin: 0.5rem 1rem;
    }

    .sidebar nav .section-title {
      padding: 1rem 1.5rem 0.5rem;
      font-size: 0.75rem;
      text-transform: uppercase;
      color: #7f8c8d;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: var(--sidebar-width);
      padding: 2rem;
      transition: margin-left 0.3s;
    }

    .main-content.expanded {
      margin-left: 0;
    }

    .content-card {
      background: var(--white);
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .content-card h2 {
      margin-bottom: 1.5rem;
      color: var(--primary-color);
      font-size: 1.75rem;
      border-bottom: 2px solid var(--secondary-color);
      padding-bottom: 0.5rem;
    }

    /* Forms */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--text-dark);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--secondary-color);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* Buttons */
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s, transform 0.1s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-primary {
      background: var(--secondary-color);
      color: var(--white);
    }

    .btn-primary:hover {
      background: #2980b9;
    }

    .btn-success {
      background: var(--success-color);
      color: var(--white);
    }

    .btn-success:hover {
      background: #229954;
    }

    .btn-warning {
      background: var(--warning-color);
      color: var(--white);
    }

    .btn-warning:hover {
      background: #e67e22;
    }

    .btn-danger {
      background: var(--danger-color);
      color: var(--white);
    }

    .btn-danger:hover {
      background: #c0392b;
    }

    .btn-group {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    /* Tables */
    .table-container {
      overflow-x: auto;
      margin-top: 1rem;
      max-height: calc(100vh - 300px);
      overflow-y: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--white);
      table-layout: auto;
      font-size: 0.85rem;
    }

    table th,
    table td {
      padding: 0.4rem 0.5rem;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
      white-space: nowrap;
      min-width: 70px;
      line-height: 1.3;
    }

    /* Larguras espec√≠ficas para colunas - 13 colunas */
    table th:nth-child(1), table td:nth-child(1) { min-width: 90px; } /* Grupo */
    table th:nth-child(2), table td:nth-child(2) { min-width: 150px; } /* Item */
    table th:nth-child(3), table td:nth-child(3) { min-width: 60px; text-align: center; font-size: 0.8rem; } /* Unidade */
    table th:nth-child(4), table td:nth-child(4) { min-width: 85px; } /* Data */
    table th:nth-child(5), table td:nth-child(5) { min-width: 70px; } /* NF */
    table th:nth-child(6), table td:nth-child(6) { min-width: 120px; white-space: normal; } /* Obs */
    table th:nth-child(7), table td:nth-child(7) { min-width: 70px; text-align: right; } /* Saldo Ant */
    table th:nth-child(8), table td:nth-child(8) { min-width: 60px; text-align: right; } /* Entrada */
    table th:nth-child(9), table td:nth-child(9) { min-width: 60px; text-align: right; } /* Sa√≠da */
    table th:nth-child(10), table td:nth-child(10) {
      min-width: 70px;
      text-align: right;
      font-weight: 700;
      background-color: #e3f2fd;
      font-size: 0.9rem;
    } /* Saldo - DESTACADO */
    table th:nth-child(11), table td:nth-child(11) { min-width: 75px; text-align: right; font-size: 0.8rem; } /* Valor */
    table th:nth-child(12), table td:nth-child(12) { min-width: 110px; font-size: 0.8rem; } /* Alterado Em */
    table th:nth-child(13), table td:nth-child(13) { min-width: 90px; } /* Alterado Por */

    /* Destaque especial para cabe√ßalho da coluna SALDO */
    table th:nth-child(10) {
      background-color: #2196f3 !important;
      color: white !important;
    }

    table th {
      background: var(--light-bg);
      font-weight: 600;
      color: var(--primary-color);
      position: sticky;
      top: 0;
      font-size: 0.85rem;
      z-index: 10;
    }

    table tr:hover {
      opacity: 0.9;
    }

    /* Cores das linhas (vermelho e amarelo) */
    table tr.row-red {
      background-color: #ff0000 !important;
      color: white;
    }

    table tr.row-red:hover {
      background-color: #cc0000 !important;
    }

    /* Mant√©m destaque na coluna SALDO mesmo em linhas vermelhas */
    table tr.row-red td:nth-child(10) {
      background-color: #d32f2f !important;
      font-weight: 700;
      border-left: 2px solid white;
      border-right: 2px solid white;
    }

    table tr.row-yellow {
      background-color: #ffff00 !important;
      color: black;
    }

    table tr.row-yellow:hover {
      background-color: #e6e600 !important;
    }

    /* Mant√©m destaque na coluna SALDO mesmo em linhas amarelas */
    table tr.row-yellow td:nth-child(10) {
      background-color: #fdd835 !important;
      font-weight: 700;
      border-left: 2px solid #f57f17;
      border-right: 2px solid #f57f17;
    }

    /* Print styles */
    @media print {
      .header, .sidebar, .sidebar-toggle, .btn, .form-group, .content-card h2, #localizarMessage {
        display: none !important;
      }

      .main-content {
        margin-left: 0 !important;
        padding: 0 !important;
      }

      .table-container {
        overflow: visible !important;
      }

      table {
        page-break-inside: auto;
        font-size: 10pt;
      }

      table tr {
        page-break-inside: avoid;
        page-break-after: auto;
      }

      table th {
        position: static;
      }
    }

    /* Login Screen */
    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    }

    .login-card {
      background: var(--white);
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      padding: 3rem;
      width: 100%;
      max-width: 400px;
    }

    .login-card h2 {
      text-align: center;
      margin-bottom: 2rem;
      color: var(--primary-color);
    }

    /* Loading Spinner */
    .loading {
      display: none;
      text-align: center;
      padding: 2rem;
    }

    .loading.show {
      display: block;
    }

    .spinner {
      border: 4px solid var(--light-bg);
      border-top: 4px solid var(--secondary-color);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Messages */
    .message {
      padding: 1rem 1.5rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      display: none;
    }

    .message.show {
      display: block;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .message.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .message.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .header h1 {
        font-size: 1.2rem;
      }

      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar:not(.hidden) {
        transform: translateX(0);
      }

      .sidebar-toggle {
        left: 10px !important;
      }

      .sidebar-toggle.shifted {
        left: 10px !important;
      }

      .main-content {
        margin-left: 0;
        padding: 1rem;
      }

      .content-card {
        padding: 1rem;
      }

      .btn-group {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }
    }

    /* Module specific styles */
    .module-container {
      display: none;
    }

    .module-container.active {
      display: block;
    }

    .dashboard-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--white);
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: center;
    }

    .stat-card h3 {
      font-size: 2rem;
      color: var(--secondary-color);
      margin-bottom: 0.5rem;
    }

    .stat-card p {
      color: #7f8c8d;
      font-size: 0.9rem;
    }

    /* Autocomplete customizado (busca do in√≠cio) */
    .autocomplete-wrapper {
      position: relative;
    }
    .autocomplete-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 200px;
      overflow-y: auto;
      background: white;
      border: 1px solid var(--border-color);
      border-top: none;
      border-radius: 0 0 4px 4px;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .autocomplete-dropdown.show {
      display: block;
    }
    .autocomplete-option {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    .autocomplete-option:hover,
    .autocomplete-option.selected {
      background: var(--secondary-color);
      color: white;
    }
    .autocomplete-option:last-child {
      border-bottom: none;
    }

    /* Modal de Confirma√ß√£o NF */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    .modal-overlay.show {
      display: flex;
    }

    /* Loading Overlay */
    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      backdrop-filter: blur(3px);
    }

    #loadingOverlay.show {
      display: flex;
    }

    .loading-content {
      background: white;
      padding: 30px 40px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
      min-width: 300px;
      max-width: 900px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--secondary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.2);
        opacity: 0.8;
      }
    }

    .loading-text {
      font-size: 1.1rem;
      color: var(--text-dark);
      font-weight: 500;
      margin-top: 10px;
    }

    .loading-subtext {
      font-size: 0.9rem;
      color: #7f8c8d;
      margin-top: 5px;
    }

    /* Lista de √öltimos Lan√ßamentos */
    .ultimos-lancamentos {
      margin-top: 25px;
      padding-top: 20px;
      border-top: 2px solid #e0e0e0;
      max-width: 800px;
      width: 100%;
    }

    .ultimos-lancamentos h4 {
      font-size: 1rem;
      color: var(--text-dark);
      margin: 0 0 15px 0;
      font-weight: 600;
    }

    .lancamentos-list {
      max-height: 300px;
      overflow-y: auto;
      background: #f8f9fa;
      border-radius: 8px;
      padding: 10px;
    }

    .loading-lancamentos {
      text-align: center;
      color: #7f8c8d;
      padding: 20px;
      font-size: 0.9rem;
    }

    .lancamento-item {
      background: white;
      border-radius: 6px;
      padding: 10px 12px;
      margin-bottom: 8px;
      border-left: 4px solid var(--primary-color);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }

    .lancamento-item:hover {
      transform: translateX(3px);
    }

    .lancamento-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }

    .lancamento-item-nome {
      font-weight: 600;
      color: var(--text-dark);
      font-size: 0.95rem;
    }

    .lancamento-data {
      font-size: 0.8rem;
      color: #7f8c8d;
    }

    .lancamento-details {
      display: flex;
      gap: 15px;
      font-size: 0.85rem;
      color: #555;
      flex-wrap: wrap;
    }

    .lancamento-detail {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .lancamento-detail strong {
      font-weight: 600;
    }

    .lancamento-entrada {
      color: #28a745;
    }

    .lancamento-saida {
      color: #dc3545;
    }

    .lancamento-saldo {
      color: var(--primary-color);
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      max-width: 95%;
      max-height: 90vh;
      width: 900px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .modal-header {
      background: var(--primary-color);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h3 {
      margin: 0;
      font-size: 1.2rem;
    }
    .modal-close {
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0 5px;
    }
    .modal-body {
      padding: 20px;
      max-height: calc(90vh - 140px);
      overflow-y: auto;
    }
    .modal-footer {
      padding: 15px 20px;
      background: #f5f5f5;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      border-top: 1px solid #ddd;
    }
    .confirm-item-row {
      display: grid;
      grid-template-columns: 40px 2fr 1fr 1fr 1fr 1fr 60px;
      gap: 10px;
      padding: 12px;
      border-bottom: 1px solid #eee;
      align-items: center;
      background: #fafafa;
      margin-bottom: 5px;
      border-radius: 4px;
    }
    .confirm-item-row.item-novo {
      background: #fff3cd;
      border: 1px solid #ffc107;
    }
    .confirm-item-row .item-index {
      font-weight: bold;
      color: #666;
      text-align: center;
    }
    .confirm-item-row .item-nome {
      font-weight: 600;
    }
    .confirm-item-row .item-novo-badge {
      background: #dc3545;
      color: white;
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 3px;
      margin-left: 5px;
    }
    .confirm-item-row .btn-ok-item {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .confirm-item-row .btn-ok-item:hover {
      background: #218838;
    }
    .confirm-item-row .btn-ok-item.confirmed {
      background: #6c757d;
    }
    .confirm-item-row .btn-ok-item.confirmed::after {
      content: ' ‚úì';
    }
    .confirm-header-row {
      display: grid;
      grid-template-columns: 40px 2fr 1fr 1fr 1fr 1fr 60px;
      gap: 10px;
      padding: 10px 12px;
      background: var(--primary-color);
      color: white;
      font-weight: 600;
      font-size: 0.85rem;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    .novo-item-warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    .novo-item-warning strong {
      color: #dc3545;
    }
    .grupo-field-novo {
      display: none;
    }
    .grupo-field-novo.show {
      display: block;
    }
    /* Estilos do Modal de Confirma√ß√£o Lote */
    .confirm-header-row-lote {
      display: grid;
      grid-template-columns: 40px 2fr 80px 80px 100px 60px;
      gap: 10px;
      padding: 10px 12px;
      background: var(--primary-color);
      color: white;
      font-weight: 600;
      font-size: 0.85rem;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    .confirm-item-row-lote {
      display: grid;
      grid-template-columns: 40px 2fr 80px 80px 100px 60px;
      gap: 10px;
      padding: 12px;
      border-bottom: 1px solid #eee;
      align-items: center;
      background: #fafafa;
      margin-bottom: 5px;
      border-radius: 4px;
    }
    .confirm-item-row-lote.item-novo {
      background: #fff3cd;
      border: 1px solid #ffc107;
    }
    .confirm-item-row-lote .item-index {
      font-weight: bold;
      color: #666;
      text-align: center;
    }
    .confirm-item-row-lote .item-nome {
      font-weight: 600;
    }
    .confirm-item-row-lote .btn-ok-item {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .confirm-item-row-lote .btn-ok-item:hover {
      background: #218838;
    }
    .confirm-item-row-lote .btn-ok-item.confirmed {
      background: #6c757d;
    }
    .confirm-item-row-lote .btn-ok-item.confirmed::after {
      content: ' ‚úì';
    }
    /* Item do Lote */
    .lote-item-row {
      display: grid;
      grid-template-columns: 2fr 1fr auto;
      gap: 8px;
      margin-bottom: 10px;
      padding: 10px;
      background: white;
      border-radius: 4px;
      align-items: end;
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginScreen" class="login-container">
    <div class="login-card">
      <img src="https://i.ibb.co/FGGjdsM/LOGO-MARFIM.jpg" alt="Logo Marfim" style="width: 120px; height: auto; margin-bottom: 15px; border-radius: 8px;">
      <h2>üîê Login</h2>
      <div id="loginMessage" class="message"></div>
      <form id="loginForm" onsubmit="return handleLogin(event)">
        <div class="form-group">
          <label for="loginUser">Usu√°rio</label>
          <input type="text" id="loginUser" required placeholder="Digite seu usu√°rio">
        </div>
        <div class="form-group">
          <label for="loginPassword">Senha</label>
          <input type="password" id="loginPassword" required placeholder="Digite sua senha">
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Entrar</button>
      </form>
      <div class="loading">
        <div class="spinner"></div>
        <p>Autenticando...</p>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="mainApp" style="display: none;">
    <!-- Header -->
    <header class="header">
      <div style="display: flex; align-items: center; gap: 12px;">
        <img src="https://i.ibb.co/FGGjdsM/LOGO-MARFIM.jpg" alt="Logo Marfim" style="height: 45px; width: auto; border-radius: 6px;">
        <h1 style="margin: 0;">Sistema de Gest√£o de Estoque</h1>
      </div>
      <div class="user-info">
        <span id="userName">Usu√°rio</span>
        <button class="logout-btn" onclick="handleLogout()">Sair</button>
      </div>
    </header>

    <!-- Sidebar Toggle -->
    <button class="sidebar-toggle shifted" onclick="toggleSidebar()">‚úï Esconder Menu</button>

    <!-- Container -->
    <div class="container">
      <!-- Sidebar -->
      <aside class="sidebar" id="sidebar">
        <nav>
          <ul>
            <li class="section-title">Principal</li>
            <li><a href="#" onclick="showModule('dashboard')" data-module="dashboard" class="active">üè† In√≠cio</a></li>

            <li class="separator"></li>
            <li class="section-title">Opera√ß√µes</li>
            <li><a href="#" onclick="showModule('inserir-estoque')" data-module="inserir-estoque">üì¶ Inserir Estoque</a></li>
            <li><a href="#" onclick="showModule('inserir-nf')" data-module="inserir-nf">üìÑ Inserir NF</a></li>
            <li><a href="#" onclick="showModule('inserir-grupo')" data-module="inserir-grupo">üìÅ Inserir Grupo</a></li>
            <li><a href="#" onclick="showModule('apagar-linha')" data-module="apagar-linha">üóëÔ∏è Apagar √öltima Linha</a></li>

            <li class="separator"></li>
            <li class="section-title">Consultas</li>
            <li><a href="#" onclick="showModule('localizar-produto')" data-module="localizar-produto">üîç Localizar Produto</a></li>
            <li><a href="#" onclick="showModule('listagem-estoque')" data-module="listagem-estoque">üìã Listagem de Estoque</a></li>

            <li class="separator"></li>
            <li class="section-title">Relat√≥rios</li>
            <li><a href="#" onclick="showModule('relatorio-estoque')" data-module="relatorio-estoque">üìä Gerar Relat√≥rio</a></li>
            <li><a href="#" onclick="showModule('estoque-3-meses')" data-module="estoque-3-meses">üì¶ Consumo em 3 Meses</a></li>

            <li class="separator"></li>
            <li class="section-title">Cores</li>
            <li><a href="#" onclick="showModule('cores-desatualizadas')" data-module="cores-desatualizadas">üé® Cores Desatualizadas</a></li>
          </ul>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="main-content" id="mainContent">
        <!-- P√°gina Inicial Module -->
        <div id="module-dashboard" class="module-container active">
          <div class="content-card" style="text-align: center; padding: 40px 20px;">
            <img src="https://i.ibb.co/FGGjdsM/LOGO-MARFIM.jpg" alt="Logo Marfim" style="width: 180px; height: auto; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            <h2 style="font-size: 1.8rem; color: #2c3e50; margin-bottom: 10px;">Sistema de Gest√£o de Estoque Inteligente</h2>
            <h3 style="font-size: 1.4rem; color: #3498db; margin-bottom: 30px; font-weight: 500;">Marfim</h3>
            <p style="color: #7f8c8d; margin-bottom: 30px;">Use o menu lateral para navegar pelas funcionalidades.</p>
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
              <p style="font-size: 0.85rem; color: #95a5a6; margin: 0;">Autor: Johnny</p>
              <p style="font-size: 0.85rem; color: #95a5a6; margin: 5px 0 0 0;">Vers√£o: 2.9.7</p>
            </div>
          </div>
        </div>

        <!-- Inserir Estoque Module -->
        <div id="module-inserir-estoque" class="module-container">
          <div class="content-card">
            <!-- FORMUL√ÅRIO DE INSER√á√ÉO -->
            <div id="estoqueFormArea">
              <h2>üì¶ Inserir Estoque</h2>
              <div id="estoqueMessage" class="message"></div>

              <!-- Aviso de item novo -->
              <div id="avisoItemNovoEstoque" class="novo-item-warning" style="display: none;">
                <strong>‚ö†Ô∏è ATEN√á√ÉO:</strong> Este item √© <strong>NOVO</strong> e n√£o existe na base de dados!
                <br>Certifique-se de que digitou corretamente para evitar problemas futuros.
              </div>

              <form id="estoqueForm" onsubmit="return handleInserirEstoque(event)" novalidate>
                <!-- Grid compacto 2 colunas -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                  <div class="form-group" style="margin-bottom: 8px;">
                    <label for="estoqueItem" style="font-size: 0.85rem;">Produto *</label>
                    <input type="text" id="estoqueItem" list="itemList" required style="padding: 6px;" onblur="verificarItemNovoEstoque()">
                    <datalist id="itemList"></datalist>
                    <small id="avisoItemNovoSmall" style="display: none; color: #dc3545; font-size: 0.75rem;">‚ö†Ô∏è Item NOVO - Verifique a digita√ß√£o!</small>
                  </div>
                  <div class="form-group" style="margin-bottom: 8px;" id="estoqueGroupContainer">
                    <label for="estoqueGroup" style="font-size: 0.85rem;">Grupo *</label>
                    <input type="text" id="estoqueGroup" list="groupList" required style="padding: 6px;">
                    <datalist id="groupList"></datalist>
                  </div>
                  <div class="form-group" style="margin-bottom: 8px;">
                    <label for="estoqueUnidade" style="font-size: 0.85rem;">Unidade *</label>
                    <select id="estoqueUnidade" required style="padding: 6px;">
                      <option value="">Selecione...</option>
                    </select>
                  </div>
                  <div class="form-group" style="margin-bottom: 8px;">
                    <label for="estoqueNF" style="font-size: 0.85rem;">NF</label>
                    <input type="text" id="estoqueNF" list="nfList" style="padding: 6px;">
                    <datalist id="nfList"></datalist>
                  </div>
                  <div class="form-group" style="margin-bottom: 8px;">
                    <label for="estoqueObs" style="font-size: 0.85rem;">Observa√ß√£o</label>
                    <select id="estoqueObs" style="padding: 6px;" onchange="toggleValorUnitario()">
                      <option value="">Selecione...</option>
                    </select>
                  </div>
                  <div class="form-group" style="margin-bottom: 8px;">
                    <label for="estoqueEntrada" style="font-size: 0.85rem;">Entrada</label>
                    <input type="number" id="estoqueEntrada" step="0.01" value="0" onchange="toggleValorUnitario()" style="padding: 6px;">
                  </div>
                  <div class="form-group" style="margin-bottom: 8px;">
                    <label for="estoqueSaida" style="font-size: 0.85rem;">Sa√≠da</label>
                    <input type="number" id="estoqueSaida" step="0.01" value="0" onchange="toggleValorUnitario()" style="padding: 6px;">
                  </div>
                  <div class="form-group" id="valorUnitarioGroup" style="margin-bottom: 8px;">
                    <label for="estoqueValorUnitario" style="font-size: 0.85rem;">Valor Unit. (R$) *</label>
                    <input type="number" id="estoqueValorUnitario" step="0.01" min="0" required style="padding: 6px;">
                  </div>
                </div>
                <div class="btn-group" style="margin-top: 10px;">
                  <button type="submit" class="btn btn-success">‚úì Confirmar</button>
                  <button type="button" class="btn btn-warning" onclick="resetEstoqueForm()">‚Üª Limpar</button>
                  <button type="button" class="btn btn-primary" onclick="abrirLancamentoLote()" title="Inserir m√∫ltiplos itens de uma vez">üì¶ Movimenta√ß√£o em Lote</button>
                </div>
              </form>

              <!-- Hist√≥rico do Produto (durante digita√ß√£o) -->
              <div id="estoqueHistorico" style="display: none; margin-top: 15px; padding: 10px; background: #f5f5f5; border-radius: 4px;">
                <h3 style="margin: 0 0 10px 0; color: #666; font-size: 0.85rem;">üìä Hist√≥rico do Produto</h3>
                <div id="estoqueHistoricoContent" class="table-container" style="max-height: 200px; overflow-y: auto;">
                </div>
              </div>
            </div>

            <!-- √ÅREA DE RESULTADOS AP√ìS INSER√á√ÉO -->
            <div id="estoqueResultArea" style="display: none;">
              <h2>‚úÖ Estoque Inserido com Sucesso!</h2>
              <div id="estoqueResultMessage" style="background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin-bottom: 15px;"></div>
              <h3 style="margin: 15px 0 10px 0; font-size: 0.9rem;">üìã Movimenta√ß√µes do Item:</h3>
              <div id="estoqueResultTable" class="table-container" style="max-height: 400px; overflow-y: auto;">
              </div>
              <div class="btn-group" style="margin-top: 15px;">
                <button type="button" class="btn btn-primary" onclick="voltarParaFormulario()">‚úì OK - Inserir Novo</button>
              </div>
            </div>

            <!-- √ÅREA DE MOVIMENTA√á√ÉO EM LOTE -->
            <div id="estoqueLoteArea" style="display: none;">
              <h2>üì¶ Movimenta√ß√£o do Estoque em Lote</h2>
              <p style="font-size: 0.85rem; color: #666; margin-bottom: 15px;">
                Insira m√∫ltiplos itens de uma vez. Escolha o tipo de opera√ß√£o, grupo, unidade e observa√ß√£o uma √∫nica vez. Depois adicione os itens com suas quantidades.
              </p>
              <div id="estoqueLoteMessage" class="message"></div>

              <!-- Campos Globais do Lote -->
              <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="margin: 0 0 10px 0; color: #2e7d32;">‚öôÔ∏è Configura√ß√µes Gerais</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                  <div class="form-group" style="margin-bottom: 8px;">
                    <label style="font-size: 0.85rem;">Tipo de Opera√ß√£o *</label>
                    <div style="display: flex; gap: 15px; padding: 8px 0;">
                      <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="radio" name="loteOperacao" value="entrada" checked style="width: auto;">
                        <span style="color: #28a745; font-weight: 600;">üì• Entrada</span>
                      </label>
                      <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="radio" name="loteOperacao" value="saida" style="width: auto;">
                        <span style="color: #dc3545; font-weight: 600;">üì§ Sa√≠da</span>
                      </label>
                    </div>
                  </div>
                  <div class="form-group" style="margin-bottom: 8px;">
                    <label style="font-size: 0.85rem;">Grupo *</label>
                    <select id="loteGrupo" required style="padding: 6px;">
                      <option value="">Selecione...</option>
                    </select>
                  </div>
                  <div class="form-group" style="margin-bottom: 8px;">
                    <label style="font-size: 0.85rem;">Unidade *</label>
                    <select id="loteUnidade" required style="padding: 6px;">
                      <option value="">Selecione...</option>
                    </select>
                  </div>
                  <div class="form-group" style="margin-bottom: 8px;">
                    <label style="font-size: 0.85rem;">Observa√ß√£o</label>
                    <select id="loteObs" style="padding: 6px;">
                      <option value="">Selecione...</option>
                    </select>
                  </div>
                  <div class="form-group" style="margin-bottom: 8px;">
                    <label style="font-size: 0.85rem;">Pedido/OC</label>
                    <input type="text" id="loteNF" list="loteNFList" style="padding: 6px;" placeholder="N√∫mero do Pedido/OC">
                    <datalist id="loteNFList"></datalist>
                  </div>
                </div>
              </div>

              <!-- Lista de Itens do Lote -->
              <div style="background: #fff8e1; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="margin: 0 0 10px 0; color: #f57c00;">üìã Itens do Lote</h4>
                <div id="loteItensContainer">
                  <!-- Itens ser√£o adicionados aqui -->
                </div>
                <button type="button" class="btn btn-primary" onclick="adicionarItemLote()" style="margin-top: 10px;">
                  + Adicionar Item
                </button>
              </div>

              <div class="btn-group">
                <button type="button" class="btn btn-success" onclick="handleInserirLote()">‚úì Confirmar Inser√ß√£o</button>
                <button type="button" class="btn btn-warning" onclick="limparFormLote()">‚Üª Limpar</button>
                <button type="button" class="btn btn-secondary" onclick="voltarParaEstoqueSimples()">‚Üê Voltar</button>
              </div>
            </div>

            <!-- √ÅREA DE RESULTADOS DO LOTE -->
            <div id="estoqueLoteResultArea" style="display: none;">
              <h2>‚úÖ Movimenta√ß√£o em Lote Conclu√≠da!</h2>
              <div id="estoqueLoteResultMessage" style="background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin-bottom: 15px;"></div>
              <h3 style="margin: 15px 0 10px 0; font-size: 0.9rem;">üìä Saldos Atualizados:</h3>
              <div id="estoqueLoteResultTable" class="table-container" style="max-height: 400px; overflow-y: auto;"></div>
              <div class="btn-group" style="margin-top: 15px;">
                <button type="button" class="btn btn-primary" onclick="voltarParaLote()">üì¶ Nova Movimenta√ß√£o em Lote</button>
                <button type="button" class="btn btn-secondary" onclick="voltarParaEstoqueSimples()">‚Üê Inser√ß√£o Simples</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Inserir NF Module (m√∫ltiplos itens) -->
        <div id="module-inserir-nf" class="module-container">
          <div class="content-card">
            <div id="nfFormArea">
              <h2>üìÑ Inserir NF (M√∫ltiplos Itens)</h2>
              <p style="font-size: 0.85rem; color: #666; margin-bottom: 15px;">Insira NF, Pedido, Unidade e Observa√ß√£o uma vez. Depois adicione os itens com seus respectivos pre√ßos, lotes e quantidades.</p>
              <div id="nfMessage" class="message"></div>

              <!-- Campos Globais -->
              <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="margin: 0 0 10px 0; color: #1976d2;">Dados Gerais</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                  <div class="form-group" style="margin-bottom: 8px;">
                    <label style="font-size: 0.85rem;">NF *</label>
                    <input type="text" id="nfNumero" required style="padding: 6px;" placeholder="N√∫mero da NF">
                  </div>
                  <div class="form-group" style="margin-bottom: 8px;">
                    <label style="font-size: 0.85rem;">Pedido</label>
                    <input type="text" id="nfPedido" style="padding: 6px;" placeholder="N√∫mero do Pedido">
                  </div>
                  <div class="form-group" style="margin-bottom: 8px;">
                    <label style="font-size: 0.85rem;">Unidade *</label>
                    <select id="nfUnidade" required style="padding: 6px;">
                      <option value="">Selecione...</option>
                    </select>
                  </div>
                  <div class="form-group" style="margin-bottom: 8px;">
                    <label style="font-size: 0.85rem;">Observa√ß√£o</label>
                    <select id="nfObs" style="padding: 6px;">
                      <option value="">Selecione...</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Lista de Itens -->
              <div style="background: #fff8e1; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="margin: 0 0 10px 0; color: #f57c00;">Itens da NF</h4>
                <div id="nfItensContainer">
                  <!-- Itens ser√£o adicionados aqui -->
                </div>
                <button type="button" class="btn btn-primary" onclick="adicionarItemNF()" style="margin-top: 10px;">
                  + Adicionar Item
                </button>
              </div>

              <div class="btn-group">
                <button type="button" class="btn btn-success" onclick="handleInserirNF()">‚úì Confirmar Inser√ß√£o</button>
                <button type="button" class="btn btn-warning" onclick="limparFormNF()">‚Üª Limpar</button>
              </div>
            </div>

            <!-- √Årea de Resultados -->
            <div id="nfResultArea" style="display: none;">
              <h2>‚úÖ Itens Inseridos com Sucesso!</h2>
              <div id="nfResultMessage" style="background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin-bottom: 15px;"></div>
              <div id="nfResultTable" class="table-container" style="max-height: 400px; overflow-y: auto;"></div>
              <div class="btn-group" style="margin-top: 15px;">
                <button type="button" class="btn btn-primary" onclick="voltarParaNF()">‚úì OK - Inserir Nova NF</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Inserir Grupo Module -->
        <div id="module-inserir-grupo" class="module-container">
          <div class="content-card">
            <h2>üìÅ Inserir Grupo</h2>
            <div id="grupoMessage" class="message"></div>
            <form id="grupoForm" onsubmit="return handleInserirGrupo(event)">
              <div class="form-group">
                <label for="grupoNome">Nome do Grupo *</label>
                <input type="text" id="grupoNome" required style="text-transform: uppercase;"
                       oninput="this.value = this.value.toUpperCase(); validarGrupoDuplicado();"
                       placeholder="Digite o nome do grupo">
                <small id="grupoValidation" style="display:none; color: #e74c3c; margin-top: 5px;"></small>
              </div>
              <div class="btn-group">
                <button type="submit" id="btnAdicionarGrupo" class="btn btn-success">‚úì Adicionar Grupo</button>
              </div>
            </form>

            <!-- Lista de grupos existentes -->
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
              <h3 style="font-size: 1rem; color: #666; margin-bottom: 10px;">üìã Grupos Existentes (<span id="totalGrupos">0</span>)</h3>
              <div id="listaGruposExistentes" style="max-height: 300px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 4px;">
                <p style="color: #999;">Carregando grupos...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Localizar Produto Module -->
        <div id="module-localizar-produto" class="module-container">
          <div class="content-card">
            <h2>üîç Localizar Produto</h2>
            <div id="localizarMessage" class="message"></div>
            <form id="localizarForm" onsubmit="return handleBuscaRapida(event)">
              <div class="form-group">
                <label for="localizarItem">Nome do Produto *</label>
                <input type="text" id="localizarItem" list="localizarItemList" required>
                <datalist id="localizarItemList"></datalist>
              </div>
              <div class="btn-group" style="flex-wrap: wrap;">
                <button type="submit" class="btn btn-primary">‚ö° Busca R√°pida (√∫ltimos 20)</button>
                <button type="button" class="btn btn-success" onclick="handleHistoricoCompleto()">üìú Hist√≥rico Completo</button>
                <button type="button" class="btn btn-warning" onclick="showAllProducts()">üìã Mostrar Todos</button>
              </div>
              <small style="color: #666; margin-top: 8px; display: block;">
                <strong>Busca R√°pida:</strong> Instant√¢nea, √∫ltimos 20 registros (cache) |
                <strong>Hist√≥rico Completo:</strong> Todos os registros do item (servidor)
              </small>
            </form>
            <div id="localizarResults" class="table-container" style="display: none;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                <h3 style="margin: 0;">Resultados da Busca (<span id="totalResults">0</span> registros)</h3>
                <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                  <label for="printDataInicio" style="margin: 0;">Per√≠odo:</label>
                  <input type="date" id="printDataInicio" style="padding: 0.5rem;">
                  <span>at√©</span>
                  <input type="date" id="printDataFim" style="padding: 0.5rem;">
                  <button class="btn btn-success" onclick="printResults(true)" style="padding: 0.5rem 1rem;">üñ®Ô∏è Imprimir Per√≠odo</button>
                  <button class="btn btn-primary" onclick="printResults(false)" style="padding: 0.5rem 1rem;">üñ®Ô∏è Imprimir Tudo</button>
                </div>
              </div>
              <div id="localizarTableContainer"></div>
            </div>
          </div>
        </div>

        <!-- Listagem de Estoque Module -->
        <div id="module-listagem-estoque" class="module-container">
          <div class="content-card">
            <h2>üìã Listagem de Estoque</h2>
            <div id="listagemMessage" class="message"></div>

            <!-- Op√ß√£o 1: Busca por Grupo -->
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
              <h3 style="margin: 0 0 10px 0; font-size: 1rem; color: #1565c0;">üìÅ Buscar por Grupo</h3>
              <p style="font-size: 0.85rem; color: #666; margin-bottom: 10px;">Mostra o √∫ltimo lan√ßamento de cada item do grupo selecionado</p>
              <div class="form-group" style="margin-bottom: 10px;">
                <label for="listagemGroup">Selecione o Grupo</label>
                <select id="listagemGroup" style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ddd;">
                  <option value="">-- Selecione um grupo --</option>
                </select>
              </div>
              <button type="button" class="btn btn-primary" onclick="handleBuscaPorGrupo()">üìä Buscar Itens do Grupo</button>
            </div>

            <!-- Op√ß√£o 2: Busca por Lista de Itens -->
            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
              <h3 style="margin: 0 0 10px 0; font-size: 1rem; color: #2e7d32;">üìù Buscar Lista de Itens</h3>
              <p style="font-size: 0.85rem; color: #666; margin-bottom: 10px;">Selecione os itens que deseja buscar (use autocomplete)</p>

              <div id="listagemItensContainer">
                <!-- Primeiro item (sempre vis√≠vel) -->
                <div class="listagem-item-row" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
                  <input type="text" class="listagem-item-input" list="listagemItemDatalist" placeholder="Digite o nome do item..." style="flex: 1; padding: 10px; border-radius: 4px; border: 1px solid #ddd;">
                  <button type="button" class="btn-remove-item" onclick="removerItemListagem(this)" style="background: #f44336; color: white; border: none; border-radius: 4px; width: 36px; height: 36px; cursor: pointer; font-size: 1.2rem;" title="Remover item">√ó</button>
                </div>
              </div>
              <datalist id="listagemItemDatalist"></datalist>

              <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button type="button" class="btn btn-secondary" onclick="adicionarItemListagem()" style="background: #607d8b; flex: 1;">‚ûï Adicionar Mais Item</button>
                <button type="button" class="btn btn-success" onclick="handleBuscaPorListaItens()" style="flex: 1;">üîç Buscar Itens</button>
              </div>
            </div>

            <div id="listagemResults" class="table-container" style="display: none; margin-top: 20px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin: 0;">Resultado (<span id="listagemTotal">0</span> itens)</h3>
                <button class="btn btn-primary" onclick="printListagem()" style="padding: 0.5rem 1rem;">üñ®Ô∏è Imprimir</button>
              </div>
              <div id="listagemTableContainer"></div>
            </div>
          </div>
        </div>

        <!-- Gerar Relat√≥rio Module -->
        <div id="module-relatorio-estoque" class="module-container">
          <div class="content-card">
            <h2>üìä Gerar Relat√≥rio</h2>
            <div id="relatorioMessage" class="message"></div>
            <form id="relatorioForm" onsubmit="return handleRelatorioEstoque(event)">
              <div class="form-group">
                <label for="relatorioDataInicio">Data In√≠cio *</label>
                <input type="date" id="relatorioDataInicio" required>
              </div>
              <div class="form-group">
                <label for="relatorioDataFim">Data Fim *</label>
                <input type="date" id="relatorioDataFim" required>
              </div>
              <div class="btn-group">
                <button type="submit" class="btn btn-primary">üìä Gerar Relat√≥rio</button>
              </div>
            </form>
            <div id="relatorioResults" class="table-container" style="display: none;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin: 0;">Relat√≥rio de Estoque - <span id="relatorioTotal">0</span> lan√ßamentos</h3>
                <button class="btn btn-primary" onclick="printRelatorio()" style="padding: 0.5rem 1rem;">üñ®Ô∏è Imprimir</button>
              </div>
              <div id="relatorioTableContainer"></div>
            </div>
          </div>
        </div>

        <!-- Consumo em 3 Meses Module -->
        <div id="module-estoque-3-meses" class="module-container">
          <div class="content-card">
            <h2>üì¶ Consumo em 3 Meses</h2>
            <p style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">Calcula o total de sa√≠das de cada item nos √∫ltimos 3 meses</p>
            <div id="estoque3MesesMessage" class="message"></div>

            <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
              <h3 style="margin: 0 0 10px 0; font-size: 1rem; color: #e65100;">üìù Selecione os Itens</h3>
              <div id="estoque3MesesItensContainer">
                <div class="estoque3m-item-row" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
                  <input type="text" class="estoque3m-item-input" list="estoque3MesesItemDatalist" placeholder="Digite o nome do item..." style="flex: 1; padding: 10px; border-radius: 4px; border: 1px solid #ddd;">
                  <button type="button" onclick="removerItemEstoque3M(this)" style="background: #f44336; color: white; border: none; border-radius: 4px; width: 36px; height: 36px; cursor: pointer; font-size: 1.2rem;" title="Remover item">√ó</button>
                </div>
              </div>
              <datalist id="estoque3MesesItemDatalist"></datalist>

              <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button type="button" class="btn btn-secondary" onclick="adicionarItemEstoque3M()" style="background: #607d8b; flex: 1;">‚ûï Adicionar Mais Item</button>
                <button type="button" class="btn btn-primary" onclick="handleEstoque3Meses()" style="flex: 1;">üìä Calcular Sa√≠das</button>
              </div>
            </div>

            <div id="estoque3MesesResults" class="table-container" style="display: none;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin: 0;">Total de Sa√≠das (√öltimos 3 Meses) - <span id="estoque3MesesTotal">0</span> itens</h3>
                <button class="btn btn-primary" onclick="printEstoque3Meses()" style="padding: 0.5rem 1rem;">üñ®Ô∏è Imprimir</button>
              </div>
              <div id="estoque3MesesTableContainer"></div>
            </div>
          </div>
        </div>

        <!-- Cores Desatualizadas Module -->
        <div id="module-cores-desatualizadas" class="module-container">
          <div class="content-card">
            <h2>üé® Cores Desatualizadas</h2>
            <p style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">Lista itens sem lan√ßamento h√° mais de 15 dias e sem "ATUALIZA√á√ÉO" na observa√ß√£o</p>
            <div id="coresMessage" class="message"></div>
            <div class="btn-group">
              <button class="btn btn-primary" onclick="handleCoresDesatualizadas()">üîç Buscar Cores Desatualizadas</button>
            </div>
            <div id="coresResults" class="table-container" style="display: none;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin: 0;">Cores Desatualizadas - <span id="coresTotal">0</span> itens</h3>
                <button class="btn btn-primary" onclick="printCores()" style="padding: 0.5rem 1rem;">üñ®Ô∏è Imprimir</button>
              </div>
              <div id="coresTableContainer"></div>
            </div>
          </div>
        </div>

        <!-- Apagar √öltima Linha Module -->
        <div id="module-apagar-linha" class="module-container">
          <div class="content-card">
            <h2>üóëÔ∏è Apagar √öltima Linha</h2>
            <p style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">Visualize as √∫ltimas entradas e corrija lan√ßamentos errados</p>
            <div id="apagarLinhaMessage" class="message"></div>

            <div class="btn-group" style="margin-bottom: 15px;">
              <button class="btn btn-primary" onclick="carregarUltimasEntradas()">üîÑ Carregar √öltimas 20 Entradas</button>
            </div>

            <div id="ultimasEntradasArea" style="display: none;">
              <div style="background: #ffebee; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <p style="color: #c62828; font-weight: bold; margin: 0 0 10px 0;">‚ö†Ô∏è A √∫ltima entrada ser√° apagada. Esta a√ß√£o n√£o pode ser desfeita!</p>
                <div id="ultimaEntradaInfo" style="background: white; padding: 10px; border-radius: 4px; margin-bottom: 10px; font-size: 0.9rem;"></div>
                <button class="btn btn-danger" onclick="confirmarApagarLinha()" style="width: 100%;">üóëÔ∏è CONFIRMAR EXCLUS√ÉO DA √öLTIMA ENTRADA</button>
              </div>

              <h3>√öltimas 20 Entradas</h3>
              <div id="ultimasEntradasTableContainer"></div>
            </div>
          </div>
        </div>

      </main>
    </div>
  </div>

  <script>
    // Global variables
    let currentUser = null;
    let autocompleteData = null;
    let allEstoqueData = null; // Armazena TODOS os dados do estoque para filtros instant√¢neos
    let estoqueHeaders = null;

    // ========================================
    // INDEXEDDB - Banco de dados local para acesso instant√¢neo
    // ========================================
    const DB_CONFIG = {
      name: 'EstoqueDB',
      version: 1,
      storeName: 'registros',
      syncInterval: 10000, // 10 segundos
      metaStore: 'meta'
    };

    let db = null;
    let syncTimer = null;

    /**
     * Inicializa o IndexedDB
     */
    function initIndexedDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_CONFIG.name, DB_CONFIG.version);

        request.onerror = () => {
          console.error('Erro ao abrir IndexedDB:', request.error);
          reject(request.error);
        };

        request.onsuccess = () => {
          db = request.result;
          console.log('IndexedDB inicializado');
          resolve(db);
        };

        request.onupgradeneeded = (event) => {
          const database = event.target.result;

          // Store principal: registros de estoque
          if (!database.objectStoreNames.contains(DB_CONFIG.storeName)) {
            const store = database.createObjectStore(DB_CONFIG.storeName, { keyPath: 'id', autoIncrement: true });
            store.createIndex('item', 'item', { unique: false });
            store.createIndex('date', 'date', { unique: false });
            store.createIndex('itemDate', ['item', 'date'], { unique: false });
          }

          // Store de metadados (√∫ltima sincroniza√ß√£o, etc)
          if (!database.objectStoreNames.contains(DB_CONFIG.metaStore)) {
            database.createObjectStore(DB_CONFIG.metaStore, { keyPath: 'key' });
          }

          console.log('IndexedDB estrutura criada');
        };
      });
    }

    /**
     * Salva registros no IndexedDB
     */
    async function saveToIndexedDB(records) {
      if (!db) return;

      return new Promise((resolve, reject) => {
        const transaction = db.transaction([DB_CONFIG.storeName], 'readwrite');
        const store = transaction.objectStore(DB_CONFIG.storeName);

        records.forEach(record => {
          store.put(record);
        });

        transaction.oncomplete = () => {
          console.log('IndexedDB: ' + records.length + ' registros salvos');
          resolve();
        };

        transaction.onerror = () => {
          console.error('Erro ao salvar no IndexedDB:', transaction.error);
          reject(transaction.error);
        };
      });
    }

    /**
     * Limpa e recarrega todos os dados no IndexedDB
     */
    async function reloadIndexedDB(serverData) {
      if (!db) return;

      return new Promise((resolve, reject) => {
        const transaction = db.transaction([DB_CONFIG.storeName, DB_CONFIG.metaStore], 'readwrite');
        const store = transaction.objectStore(DB_CONFIG.storeName);
        const metaStore = transaction.objectStore(DB_CONFIG.metaStore);

        // Limpa dados antigos
        store.clear();

        // Adiciona novos dados
        serverData.forEach((record, index) => {
          store.put({
            id: index + 1,
            row: record.row,
            item: record.row[1] ? record.row[1].toString().trim().toLowerCase() : '',
            date: record.date,
            background: record.background
          });
        });

        // Salva timestamp da √∫ltima sincroniza√ß√£o
        metaStore.put({ key: 'lastSync', value: Date.now() });
        metaStore.put({ key: 'recordCount', value: serverData.length });

        transaction.oncomplete = () => {
          console.log('IndexedDB recarregado: ' + serverData.length + ' registros');
          resolve();
        };

        transaction.onerror = () => reject(transaction.error);
      });
    }

    /**
     * Busca registros de um item no IndexedDB (INSTANT√ÇNEO!)
     */
    async function getFromIndexedDB(itemName, limit) {
      if (!db) return null;

      limit = limit || 20;
      const itemKey = itemName ? itemName.toString().trim().toLowerCase() : '';

      return new Promise((resolve, reject) => {
        const transaction = db.transaction([DB_CONFIG.storeName], 'readonly');
        const store = transaction.objectStore(DB_CONFIG.storeName);
        const index = store.index('item');
        const results = [];

        const request = index.openCursor(IDBKeyRange.only(itemKey));

        request.onsuccess = (event) => {
          const cursor = event.target.result;
          if (cursor) {
            results.push(cursor.value);
            cursor.continue();
          } else {
            // Ordena por data (mais novo primeiro) e limita
            results.sort((a, b) => b.date - a.date);
            resolve(results.slice(0, limit));
          }
        };

        request.onerror = () => reject(request.error);
      });
    }

    /**
     * Busca todos os registros do IndexedDB
     */
    async function getAllFromIndexedDB() {
      if (!db) return [];

      return new Promise((resolve, reject) => {
        const transaction = db.transaction([DB_CONFIG.storeName], 'readonly');
        const store = transaction.objectStore(DB_CONFIG.storeName);
        const request = store.getAll();

        request.onsuccess = () => resolve(request.result || []);
        request.onerror = () => reject(request.error);
      });
    }

    /**
     * Obt√©m timestamp da √∫ltima sincroniza√ß√£o
     */
    async function getLastSyncTime() {
      if (!db) return 0;

      return new Promise((resolve) => {
        const transaction = db.transaction([DB_CONFIG.metaStore], 'readonly');
        const store = transaction.objectStore(DB_CONFIG.metaStore);
        const request = store.get('lastSync');

        request.onsuccess = () => resolve(request.result ? request.result.value : 0);
        request.onerror = () => resolve(0);
      });
    }

    /**
     * Sincroniza√ß√£o inicial - carrega TODOS os dados do servidor (PAGINADO)
     * Carrega 2000 registros por vez at√© completar todos os dados
     */
    async function initialSync() {
      console.log('Sincroniza√ß√£o inicial (paginada)...');

      let totalRecords = 0;
      let currentPage = 0;
      let totalPages = 1;
      let totalRows = 0;

      // Limpa IndexedDB antes de carregar tudo
      if (db) {
        try {
          const transaction = db.transaction([DB_CONFIG.storeName], 'readwrite');
          transaction.objectStore(DB_CONFIG.storeName).clear();
        } catch (e) {
          console.log('Erro ao limpar IndexedDB:', e);
        }
      }

      // Carrega p√°gina por p√°gina
      while (currentPage < totalPages) {
        showSyncStatus('Carregando ' + (currentPage + 1) + '/' + totalPages + '...', 'info');

        try {
          const result = await loadSyncPage(currentPage);

          if (result && result.success) {
            totalPages = result.totalPages || 1;
            totalRows = result.totalRows || 0;

            if (result.data && result.data.length > 0) {
              // Salva esta p√°gina no IndexedDB
              await savePageToIndexedDB(result.data, currentPage);
              totalRecords += result.data.length;
              console.log('P√°gina ' + (currentPage + 1) + '/' + totalPages + ': ' + result.data.length + ' registros (total: ' + totalRecords + ')');
            }

            if (result.done) {
              break;
            }

            currentPage++;
          } else {
            console.error('Erro na p√°gina ' + currentPage + ':', result);
            break;
          }
        } catch (e) {
          console.error('Erro ao carregar p√°gina ' + currentPage + ':', e);
          break;
        }
      }

      // Salva timestamp da sincroniza√ß√£o
      if (db) {
        try {
          const metaTransaction = db.transaction([DB_CONFIG.metaStore], 'readwrite');
          const metaStore = metaTransaction.objectStore(DB_CONFIG.metaStore);
          metaStore.put({ key: 'lastSync', value: Date.now() });
          metaStore.put({ key: 'recordCount', value: totalRecords });
        } catch (e) {
          console.log('Erro ao salvar meta:', e);
        }
      }

      // Constr√≥i √≠ndice em mem√≥ria
      await buildMemoryIndexFromIDB();

      showSyncStatus('Sincronizado! (' + totalRecords + '/' + totalRows + ')', 'success');
      setTimeout(() => hideSyncStatus(), 3000);

      console.log('Sincroniza√ß√£o completa: ' + totalRecords + ' registros carregados');
    }

    /**
     * Carrega uma p√°gina de dados do servidor
     */
    function loadSyncPage(page) {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .getAllDataForSync(page);
      });
    }

    /**
     * Salva uma p√°gina de dados no IndexedDB
     * Formato compacto do servidor: [[row, timestamp], ...]
     */
    async function savePageToIndexedDB(records, pageNum) {
      if (!db || !records || records.length === 0) return;

      return new Promise((resolve, reject) => {
        const transaction = db.transaction([DB_CONFIG.storeName], 'readwrite');
        const store = transaction.objectStore(DB_CONFIG.storeName);

        records.forEach((record, idx) => {
          // Suporta formato compacto [row, timestamp] e formato antigo {row, date}
          const row = Array.isArray(record) ? record[0] : record.row;
          const date = Array.isArray(record) ? record[1] : record.date;

          const id = (pageNum * 10000) + idx + 1;
          store.put({
            id: id,
            row: row,
            item: row[1] ? row[1].toString().trim().toLowerCase() : '',
            date: date,
            background: null
          });
        });

        transaction.oncomplete = () => resolve();
        transaction.onerror = () => reject(transaction.error);
      });
    }

    /**
     * Sincroniza√ß√£o incremental - busca apenas novos registros (a cada 10 segundos)
     */
    async function incrementalSync() {
      if (!db) return;

      const lastSync = await getLastSyncTime();
      console.log('Sync incremental desde:', new Date(lastSync).toLocaleString());

      google.script.run
        .withSuccessHandler(async function(result) {
          if (result && result.success && result.newRecords && result.newRecords.length > 0) {
            console.log('Novos registros encontrados:', result.newRecords.length);

            // Adiciona novos registros ao IndexedDB
            const records = result.newRecords.map((record, idx) => ({
              id: Date.now() + idx, // ID √∫nico
              row: record.row,
              item: record.row[1] ? record.row[1].toString().trim().toLowerCase() : '',
              date: record.date,
              background: record.background
            }));

            await saveToIndexedDB(records);

            // Atualiza timestamp
            const transaction = db.transaction([DB_CONFIG.metaStore], 'readwrite');
            transaction.objectStore(DB_CONFIG.metaStore).put({ key: 'lastSync', value: Date.now() });

            // Atualiza √≠ndice em mem√≥ria
            buildMemoryIndexFromIDB();

            // Mostra indicador discreto
            showSyncStatus('+' + result.newRecords.length + ' novos', 'success');
            setTimeout(() => hideSyncStatus(), 1500);
          }
        })
        .withFailureHandler(function(error) {
          console.log('Erro sync incremental:', error.message);
        })
        .getNewRecordsSince(lastSync);
    }

    /**
     * Inicia sincroniza√ß√£o autom√°tica a cada 10 segundos
     */
    function startAutoSync() {
      if (syncTimer) clearInterval(syncTimer);

      syncTimer = setInterval(() => {
        incrementalSync();
      }, DB_CONFIG.syncInterval);

      console.log('Auto-sync iniciado: a cada ' + (DB_CONFIG.syncInterval/1000) + ' segundos');
    }

    /**
     * Para sincroniza√ß√£o autom√°tica
     */
    function stopAutoSync() {
      if (syncTimer) {
        clearInterval(syncTimer);
        syncTimer = null;
      }
    }

    /**
     * Constr√≥i √≠ndice em mem√≥ria a partir do IndexedDB
     */
    async function buildMemoryIndexFromIDB() {
      const allRecords = await getAllFromIndexedDB();
      const index = {};

      allRecords.forEach(record => {
        const itemKey = record.item;
        if (!itemKey) return;

        if (!index[itemKey]) {
          index[itemKey] = {
            info: {
              item: record.row[1],
              group: record.row[0],
              lastDate: record.row[3],
              lastStock: record.row[9],
              unidade: record.row[2]
            },
            history: []
          };
        }

        index[itemKey].history.push({
          row: record.row,
          date: record.date,
          background: record.background
        });

        // Atualiza info se mais recente
        if (record.date > new Date(index[itemKey].info.lastDate).getTime()) {
          index[itemKey].info.lastDate = record.row[3];
          index[itemKey].info.lastStock = record.row[9];
          index[itemKey].info.group = record.row[0];
        }
      });

      // Ordena hist√≥rico de cada item
      for (const key in index) {
        index[key].history.sort((a, b) => b.date - a.date);
        index[key].history = index[key].history.slice(0, 20); // Mant√©m √∫ltimos 20
      }

      itemHistoryIndex = index;
      console.log('√çndice em mem√≥ria atualizado: ' + Object.keys(index).length + ' itens');
    }

    /**
     * Mostra status de sincroniza√ß√£o
     */
    function showSyncStatus(message, type) {
      let statusEl = document.getElementById('syncStatus');
      if (!statusEl) {
        statusEl = document.createElement('div');
        statusEl.id = 'syncStatus';
        statusEl.style.cssText = 'position:fixed;bottom:20px;right:20px;padding:8px 16px;border-radius:4px;font-size:12px;z-index:9999;transition:opacity 0.3s;';
        document.body.appendChild(statusEl);
      }

      statusEl.textContent = message;
      statusEl.style.opacity = '1';

      if (type === 'success') {
        statusEl.style.background = '#4CAF50';
        statusEl.style.color = 'white';
      } else if (type === 'error') {
        statusEl.style.background = '#f44336';
        statusEl.style.color = 'white';
      } else {
        statusEl.style.background = '#2196F3';
        statusEl.style.color = 'white';
      }
    }

    function hideSyncStatus() {
      const statusEl = document.getElementById('syncStatus');
      if (statusEl) {
        statusEl.style.opacity = '0';
      }
    }

    // ========================================
    // CACHE NO CLIENTE - localStorage
    // ========================================
    const CLIENT_CACHE = {
      AUTOCOMPLETE_KEY: 'estoque_autocomplete',
      HISTORY_INDEX_KEY: 'estoque_history_index',
      AUTOCOMPLETE_TTL: 600000, // 10 minutos em ms
      HISTORY_INDEX_TTL: 300000, // 5 minutos em ms
      TIMESTAMP_KEY: 'estoque_cache_timestamp'
    };

    // √çndice de hist√≥rico em mem√≥ria (cache RAM para acesso instant√¢neo)
    let itemHistoryIndex = null;

    function getClientCache(key) {
      try {
        const timestamp = localStorage.getItem(CLIENT_CACHE.TIMESTAMP_KEY + '_' + key);
        const data = localStorage.getItem(key);

        if (timestamp && data) {
          const age = Date.now() - parseInt(timestamp);
          if (age < CLIENT_CACHE.AUTOCOMPLETE_TTL) {
            console.log('Cache HIT (cliente): ' + key + ' (idade: ' + Math.round(age/1000) + 's)');
            return JSON.parse(data);
          }
        }
      } catch (e) {
        console.log('Erro ao ler cache cliente:', e);
      }
      return null;
    }

    function setClientCache(key, data) {
      try {
        localStorage.setItem(key, JSON.stringify(data));
        localStorage.setItem(CLIENT_CACHE.TIMESTAMP_KEY + '_' + key, Date.now().toString());
        console.log('Cache salvo (cliente): ' + key);
      } catch (e) {
        console.log('Erro ao salvar cache cliente:', e);
      }
    }

    function clearClientCache() {
      try {
        localStorage.removeItem(CLIENT_CACHE.AUTOCOMPLETE_KEY);
        localStorage.removeItem(CLIENT_CACHE.TIMESTAMP_KEY + '_' + CLIENT_CACHE.AUTOCOMPLETE_KEY);
        localStorage.removeItem(CLIENT_CACHE.HISTORY_INDEX_KEY);
        localStorage.removeItem(CLIENT_CACHE.TIMESTAMP_KEY + '_' + CLIENT_CACHE.HISTORY_INDEX_KEY);
        itemHistoryIndex = null; // Limpa cache em mem√≥ria tamb√©m
        console.log('Cache cliente limpo');
      } catch (e) {
        console.log('Erro ao limpar cache:', e);
      }
    }

    // ========================================
    // √çNDICE DE HIST√ìRICO - √öltimos 20 registros por item
    // ========================================

    /**
     * Carrega o √≠ndice de hist√≥rico (cache localStorage -> cache mem√≥ria -> servidor)
     * Este √≠ndice cont√©m os √∫ltimos 20 registros de cada item para acesso INSTANT√ÇNEO
     */
    function loadItemHistoryIndex() {
      // 1. Tenta cache em mem√≥ria (mais r√°pido)
      if (itemHistoryIndex && Object.keys(itemHistoryIndex).length > 0) {
        console.log('√çndice hist√≥rico: usando cache em mem√≥ria');
        return;
      }

      // 2. Tenta localStorage
      try {
        const timestamp = localStorage.getItem(CLIENT_CACHE.TIMESTAMP_KEY + '_' + CLIENT_CACHE.HISTORY_INDEX_KEY);
        const data = localStorage.getItem(CLIENT_CACHE.HISTORY_INDEX_KEY);

        if (timestamp && data) {
          const age = Date.now() - parseInt(timestamp);
          if (age < CLIENT_CACHE.HISTORY_INDEX_TTL) {
            itemHistoryIndex = JSON.parse(data);
            console.log('√çndice hist√≥rico: carregado do localStorage (' + Object.keys(itemHistoryIndex).length + ' itens)');

            // Atualiza em background
            refreshHistoryIndexInBackground();
            return;
          }
        }
      } catch (e) {
        console.log('Erro ao ler √≠ndice do localStorage:', e);
      }

      // 3. Busca do servidor
      console.log('√çndice hist√≥rico: buscando do servidor...');
      fetchHistoryIndexFromServer();
    }

    /**
     * Busca o √≠ndice de hist√≥rico do servidor
     */
    function fetchHistoryIndexFromServer() {
      google.script.run
        .withSuccessHandler(function(index) {
          if (index && Object.keys(index).length > 0) {
            itemHistoryIndex = index;
            saveHistoryIndexToLocalStorage(index);
            console.log('√çndice hist√≥rico carregado do servidor: ' + Object.keys(index).length + ' itens');
          }
        })
        .withFailureHandler(function(error) {
          console.error('Erro ao carregar √≠ndice de hist√≥rico:', error);
        })
        .getItemHistoryIndex();
    }

    /**
     * Atualiza o √≠ndice em background (n√£o bloqueia a UI)
     */
    function refreshHistoryIndexInBackground() {
      google.script.run
        .withSuccessHandler(function(index) {
          if (index && Object.keys(index).length > 0) {
            itemHistoryIndex = index;
            saveHistoryIndexToLocalStorage(index);
            console.log('√çndice hist√≥rico atualizado em background');
          }
        })
        .withFailureHandler(function(error) {
          console.log('Falha ao atualizar √≠ndice em background:', error);
        })
        .getItemHistoryIndex();
    }

    /**
     * Salva o √≠ndice no localStorage
     */
    function saveHistoryIndexToLocalStorage(index) {
      try {
        const jsonData = JSON.stringify(index);
        // localStorage tem limite de ~5MB, verificamos se cabe
        if (jsonData.length < 4000000) { // 4MB limite seguro
          localStorage.setItem(CLIENT_CACHE.HISTORY_INDEX_KEY, jsonData);
          localStorage.setItem(CLIENT_CACHE.TIMESTAMP_KEY + '_' + CLIENT_CACHE.HISTORY_INDEX_KEY, Date.now().toString());
          console.log('√çndice hist√≥rico salvo no localStorage (' + Math.round(jsonData.length/1024) + 'KB)');
        } else {
          console.log('√çndice muito grande para localStorage, usando apenas mem√≥ria');
        }
      } catch (e) {
        console.log('Erro ao salvar √≠ndice no localStorage:', e);
      }
    }

    /**
     * Busca hist√≥rico de um item no √≠ndice local (INSTANT√ÇNEO!)
     * @param {string} item - Nome do item
     * @returns {object|null} - Dados do hist√≥rico ou null se n√£o encontrado
     */
    function getItemHistoryFromIndex(item) {
      if (!item || !itemHistoryIndex) return null;

      const itemKey = item.toString().trim().toLowerCase();

      // Busca exata primeiro
      if (itemHistoryIndex[itemKey]) {
        return itemHistoryIndex[itemKey];
      }

      // Busca parcial (para autocomplete)
      for (const key in itemHistoryIndex) {
        if (key.indexOf(itemKey) >= 0 || itemKey.indexOf(key) >= 0) {
          return itemHistoryIndex[key];
        }
      }

      return null;
    }

    /**
     * Formata dados do √≠ndice para exibi√ß√£o na tabela
     * Garante ordena√ß√£o do mais novo para o mais antigo
     */
    function formatHistoryForDisplay(historyData, maxRecords) {
      if (!historyData || !historyData.history) return null;

      maxRecords = maxRecords || 10;

      // Cria c√≥pia e ordena por data (mais novo primeiro)
      const sortedHistory = historyData.history.slice().sort(function(a, b) {
        return b.date - a.date;
      });

      const limitedHistory = sortedHistory.slice(0, maxRecords);

      const rows = [];
      const colors = [];

      for (let i = 0; i < limitedHistory.length; i++) {
        rows.push(limitedHistory[i].row);
        colors.push(limitedHistory[i].background);
      }

      return {
        headers: ["Grupo", "Item", "Unidade", "Data", "NF", "Obs", "Saldo Anterior", "Entrada", "Sa√≠da", "Saldo", "Valor", "Alterado Em", "Alterado Por"],
        rows: rows,
        colors: colors
      };
    }

    // Initialize app
    window.onload = function() {
      // Check if user is already logged in (for development)
      // In production, this would check a session
    };

    // Login handler
    function handleLogin(event) {
      event.preventDefault();
      const username = document.getElementById('loginUser').value;
      const password = document.getElementById('loginPassword').value;

      showLoading('Autenticando...');

      google.script.run
        .withSuccessHandler(async function(result) {
          hideLoading();
          if (result.success) {
            currentUser = result.user;
            document.getElementById('userName').textContent = currentUser;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';

            // Carrega dados b√°sicos
            loadDashboardData();
            loadAutocompleteData();

            // Carrega √≠ndice de hist√≥rico (√∫ltimos 20 registros por item)
            // O √≠ndice usa cache do servidor (5 min) + cache localStorage
            loadItemHistoryIndex();
          } else {
            showMessage('loginMessage', result.message || 'Login falhou', 'error');
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showMessage('loginMessage', 'Erro ao fazer login: ' + error.message, 'error');
        })
        .loginUser(username, password);

      return false;
    }

    // Logout handler
    function handleLogout() {
      if (confirm('Deseja realmente sair?')) {
        stopAutoSync(); // Para sincroniza√ß√£o autom√°tica
        google.script.run
          .withSuccessHandler(function() {
            location.reload();
          })
          .logoutUser();
      }
    }

    // Show message
    function showMessage(elementId, message, type) {
      const msgElement = document.getElementById(elementId);
      if (!msgElement) {
        console.warn('Elemento de mensagem n√£o encontrado:', elementId);
        return;
      }
      msgElement.textContent = message;
      msgElement.className = 'message ' + type + ' show';
      setTimeout(() => msgElement.classList.remove('show'), 5000);
    }

    // Hide message
    function hideMessage(elementId) {
      const msgElement = document.getElementById(elementId);
      if (!msgElement) {
        console.warn('Elemento de mensagem n√£o encontrado:', elementId);
        return;
      }
      msgElement.textContent = '';
      msgElement.className = 'message';
    }

    // Show loading overlay
    function showLoading(message = 'Processando...') {
      const overlay = document.getElementById('loadingOverlay');
      const loadingText = document.getElementById('loadingText');
      if (overlay && loadingText) {
        loadingText.textContent = message;
        overlay.classList.add('show');
        // Disable scrolling
        document.body.style.overflow = 'hidden';

        // Carrega √∫ltimos lan√ßamentos
        carregarUltimosLancamentos();
      }
    }

    // Carrega e exibe os √∫ltimos 20 lan√ßamentos
    function carregarUltimosLancamentos() {
      const lancamentosList = document.getElementById('lancamentosList');
      if (!lancamentosList) return;

      // Mostra loading
      lancamentosList.innerHTML = '<div class="loading-lancamentos">Carregando lan√ßamentos...</div>';

      // Busca os lan√ßamentos do servidor
      google.script.run
        .withSuccessHandler(function(lancamentos) {
          if (!lancamentos || lancamentos.length === 0) {
            lancamentosList.innerHTML = '<div class="loading-lancamentos">Nenhum lan√ßamento encontrado</div>';
            return;
          }

          // Renderiza os lan√ßamentos
          let html = '';
          for (let i = 0; i < lancamentos.length; i++) {
            const lanc = lancamentos[i];

            // Formata entrada/sa√≠da
            const entradaHtml = parseFloat(lanc.entrada) > 0
              ? `<span class="lancamento-detail lancamento-entrada">‚Üë ${lanc.entrada}</span>`
              : '';
            const saidaHtml = parseFloat(lanc.saida) > 0
              ? `<span class="lancamento-detail lancamento-saida">‚Üì ${lanc.saida}</span>`
              : '';

            html += `
              <div class="lancamento-item">
                <div class="lancamento-header">
                  <div class="lancamento-item-nome">${lanc.item}</div>
                  <div class="lancamento-data">${lanc.data}</div>
                </div>
                <div class="lancamento-details">
                  <span class="lancamento-detail"><strong>Grupo:</strong> ${lanc.grupo}</span>
                  ${entradaHtml}
                  ${saidaHtml}
                  <span class="lancamento-detail lancamento-saldo"><strong>Saldo:</strong> ${lanc.saldo}</span>
                  ${lanc.nf ? `<span class="lancamento-detail"><strong>NF:</strong> ${lanc.nf}</span>` : ''}
                </div>
              </div>
            `;
          }

          lancamentosList.innerHTML = html;
        })
        .withFailureHandler(function(error) {
          console.error('Erro ao carregar lan√ßamentos:', error);
          lancamentosList.innerHTML = '<div class="loading-lancamentos">Erro ao carregar lan√ßamentos</div>';
        })
        .getUltimosLancamentos();
    }

    // Hide loading overlay
    function hideLoading() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.classList.remove('show');
        // Re-enable scrolling
        document.body.style.overflow = '';
      }
    }

    // Toggle sidebar
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');
      const toggleBtn = document.querySelector('.sidebar-toggle');

      sidebar.classList.toggle('hidden');
      mainContent.classList.toggle('expanded');
      toggleBtn.classList.toggle('shifted');

      // Altera o texto do bot√£o
      if (sidebar.classList.contains('hidden')) {
        toggleBtn.innerHTML = '‚ò∞ Mostrar Menu';
      } else {
        toggleBtn.innerHTML = '‚úï Esconder Menu';
      }
    }

    // Show module
    function showModule(moduleName) {
      // Hide all modules
      document.querySelectorAll('.module-container').forEach(module => {
        module.classList.remove('active');
      });

      // Show selected module
      document.getElementById('module-' + moduleName).classList.add('active');

      // Update sidebar active state
      document.querySelectorAll('.sidebar nav a').forEach(link => {
        link.classList.remove('active');
      });
      document.querySelector('[data-module="' + moduleName + '"]').classList.add('active');

      // A√ß√µes espec√≠ficas por m√≥dulo
      if (moduleName === 'inserir-grupo') {
        atualizarListaGrupos();
      }

      // Fecha o sidebar automaticamente ap√≥s selecionar um m√≥dulo
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');
      const toggleBtn = document.querySelector('.sidebar-toggle');

      sidebar.classList.add('hidden');
      mainContent.classList.add('expanded');
      if (toggleBtn) {
        toggleBtn.innerHTML = '‚ò∞ Menu';
      }
    }

    // Load dashboard data
    function loadDashboardData() {
      google.script.run
        .withSuccessHandler(function(data) {
          const totalItemsEl = document.getElementById('totalItems');
          const totalGroupsEl = document.getElementById('totalGroups');
          const recentEntriesEl = document.getElementById('recentEntries');
          const recentExitsEl = document.getElementById('recentExits');

          if (totalItemsEl) totalItemsEl.textContent = data.totalItems || '-';
          if (totalGroupsEl) totalGroupsEl.textContent = data.totalGroups || '-';
          if (recentEntriesEl) recentEntriesEl.textContent = data.recentEntries || '-';
          if (recentExitsEl) recentExitsEl.textContent = data.recentExits || '-';
        })
        .withFailureHandler(function(error) {
          console.error('Erro ao carregar dashboard:', error);
        })
        .getDashboardData();
    }

    // Load autocomplete data - OTIMIZADO com cache cliente
    function loadAutocompleteData() {
      // Tenta usar cache do cliente primeiro (resposta instant√¢nea)
      const cachedData = getClientCache(CLIENT_CACHE.AUTOCOMPLETE_KEY);

      if (cachedData && cachedData.items && cachedData.items.length > 0) {
        console.log('Usando autocomplete do cache cliente (' + cachedData.items.length + ' itens)');
        applyAutocompleteData(cachedData);

        // Atualiza em background para pr√≥xima vez
        google.script.run
          .withSuccessHandler(function(data) {
            if (data && data.items) {
              setClientCache(CLIENT_CACHE.AUTOCOMPLETE_KEY, data);
              // Tamb√©m atualiza na tela para manter sincronizado
              applyAutocompleteData(data);
            }
          })
          .withFailureHandler(function(error) {
            console.error('Erro ao atualizar autocomplete em background:', error);
          })
          .getAllAutocompleteData();
        return;
      }

      // Sem cache v√°lido - busca do servidor
      console.log('Buscando autocomplete do servidor...');
      google.script.run
        .withSuccessHandler(function(data) {
          if (data && data.items) {
            autocompleteData = data;
            applyAutocompleteData(data);
            setClientCache(CLIENT_CACHE.AUTOCOMPLETE_KEY, data);
            console.log('Autocomplete carregado: ' + data.items.length + ' itens');
          } else {
            console.error('Dados de autocomplete inv√°lidos:', data);
          }
        })
        .withFailureHandler(function(error) {
          console.error('Erro ao carregar autocomplete:', error);
        })
        .getAllAutocompleteData();
    }

    // Aplica dados de autocomplete nos campos
    function applyAutocompleteData(data) {
      if (!data) {
        console.error('applyAutocompleteData: dados vazios');
        return;
      }

      autocompleteData = data;
      populateAutocomplete('itemList', data.items || []);
      populateAutocomplete('groupList', data.groups || []);
      populateAutocomplete('nfList', data.nfs || []);
      populateAutocomplete('localizarItemList', data.items || []);
      populateAutocomplete('listagemGroupList', data.groups || []);
      populateAutocomplete('listagemItemList', data.items || []);
      populateAutocomplete('listagemItemDatalist', data.items || []);
      populateAutocomplete('estoque3MesesItemDatalist', data.items || []);
      populateSelect('listagemGroup', data.groups || []);
      populateSelect('estoqueUnidade', data.medidas || []);
      populateSelect('estoqueObs', data.observacoes || []);
      populateSelect('nfUnidade', data.medidas || []);
      populateSelect('nfObs', data.observacoes || []);

      // Popula selects do Lan√ßamento em Lote
      populateSelect('loteGrupo', data.groups || []);
      populateSelect('loteUnidade', data.medidas || []);
      populateSelect('loteObs', data.observacoes || []);
      populateAutocomplete('loteNFList', data.nfs || []);

      // Inicializa autocompletes customizados (apenas uma vez)
      if (!window.customAutocompletesInitialized) {
        initCustomAutocompletes();
        window.customAutocompletesInitialized = true;
      }

      console.log('Autocomplete aplicado - itens:', (data.items || []).length, ', grupos:', (data.groups || []).length);
    }

    // Toggle valor unit√°rio visibility based on rules
    function toggleValorUnitario() {
      const obs = document.getElementById('estoqueObs').value.toUpperCase();
      const valorGroup = document.getElementById('valorUnitarioGroup');
      const valorInput = document.getElementById('estoqueValorUnitario');

      // Regra: Valor unit√°rio obrigat√≥rio SE obs ‚â† "ATUALIZA√á√ÉO"
      if (obs !== 'ATUALIZA√á√ÉO') {
        valorGroup.style.display = 'block';
        valorInput.required = true;
      } else {
        valorGroup.style.display = 'none';
        valorInput.required = false;
        valorInput.value = ''; // Limpa o valor
      }
    }

    // Timeout para verifica√ß√£o de item novo (evita disparar durante sele√ß√£o do autocomplete)
    let verificarItemNovoTimeout;

    // Cache de saldo pr√©-carregado para acelerar exibi√ß√£o do resultado
    let saldoPreCarregado = {
      item: null,
      saldo: 0,
      carregando: false
    };

    // Pr√©-carrega o saldo do item em background
    function preCarregarSaldo(itemName) {
      if (!itemName || itemName.trim() === '') return;

      const itemNormalizado = itemName.trim();

      // Se j√° est√° carregando o mesmo item, n√£o faz nada
      if (saldoPreCarregado.item === itemNormalizado && saldoPreCarregado.carregando) return;

      // Se j√° tem o saldo deste item, n√£o precisa buscar
      if (saldoPreCarregado.item === itemNormalizado && !saldoPreCarregado.carregando) return;

      saldoPreCarregado.item = itemNormalizado;
      saldoPreCarregado.carregando = true;
      saldoPreCarregado.saldo = 0;

      console.log('Pr√©-carregando saldo para:', itemNormalizado);

      google.script.run
        .withSuccessHandler(function(result) {
          if (result && saldoPreCarregado.item === itemNormalizado) {
            saldoPreCarregado.saldo = parseFloat(result.lastStock) || 0;
            saldoPreCarregado.carregando = false;
            console.log('Saldo pr√©-carregado:', saldoPreCarregado.saldo);
          }
        })
        .withFailureHandler(function(error) {
          console.log('Erro ao pr√©-carregar saldo:', error);
          saldoPreCarregado.carregando = false;
        })
        .getLastRegistrationOpt(itemNormalizado);
    }

    // Verifica se o item √© novo no m√≥dulo Inserir Estoque
    // Usa delay para aguardar o usu√°rio terminar de selecionar do autocomplete
    function verificarItemNovoEstoque() {
      // Limpa timeout anterior
      clearTimeout(verificarItemNovoTimeout);

      // Aguarda 400ms ap√≥s o blur para verificar (tempo para selecionar do datalist)
      verificarItemNovoTimeout = setTimeout(function() {
        const itemInput = document.getElementById('estoqueItem');
        const nomeItem = itemInput.value.trim().toUpperCase();
        const avisoGrande = document.getElementById('avisoItemNovoEstoque');
        const avisoPequeno = document.getElementById('avisoItemNovoSmall');
        const grupoContainer = document.getElementById('estoqueGroupContainer');

        if (!nomeItem) {
          avisoGrande.style.display = 'none';
          avisoPequeno.style.display = 'none';
          grupoContainer.style.background = '';
          grupoContainer.style.padding = '';
          grupoContainer.style.border = '';
          return;
        }

        // Pr√©-carrega o saldo do item em background (para acelerar resultado)
        preCarregarSaldo(itemInput.value.trim());

        // Verifica se item existe na lista de autocomplete
        const itemExiste = autocompleteData && autocompleteData.items &&
          autocompleteData.items.some(item => item.toUpperCase() === nomeItem);

        if (!itemExiste) {
          avisoGrande.style.display = 'block';
          avisoPequeno.style.display = 'block';
          grupoContainer.style.background = '#fff3cd';
          grupoContainer.style.padding = '8px';
          grupoContainer.style.borderRadius = '4px';
          grupoContainer.style.border = '1px solid #ffc107';
        } else {
          avisoGrande.style.display = 'none';
          avisoPequeno.style.display = 'none';
          grupoContainer.style.background = '';
          grupoContainer.style.padding = '';
          grupoContainer.style.border = '';
        }
      }, 400);
    }

    // Show product history when item is typed (OTIMIZADO: √≠ndice local primeiro, servidor como fallback)
    let historyTimeout;
    function showProductHistory(item) {
      if (!item || item.trim() === '') {
        document.getElementById('estoqueHistorico').style.display = 'none';
        return;
      }

      // Debounce reduzido para 300ms (antes era 800ms) - agora √© mais r√°pido!
      clearTimeout(historyTimeout);
      historyTimeout = setTimeout(function() {
        // 1. TENTA √çNDICE LOCAL PRIMEIRO (INSTANT√ÇNEO!)
        const localHistory = getItemHistoryFromIndex(item);
        if (localHistory) {
          const displayData = formatHistoryForDisplay(localHistory, 10);
          if (displayData && displayData.rows.length > 0) {
            // Adiciona info do item acima da tabela
            const infoHtml = '<div style="margin-bottom:8px;font-size:0.8rem;color:#333;">' +
              '<strong>Saldo Atual:</strong> ' + (localHistory.info.lastStock || '0') +
              ' | <strong>√öltima Atualiza√ß√£o:</strong> ' + (localHistory.info.lastDate || '-') +
              ' | <strong>Grupo:</strong> ' + (localHistory.info.group || '-') +
              '</div>';

            document.getElementById('estoqueHistoricoContent').innerHTML = infoHtml;
            displayTable('estoqueHistoricoContent', displayData);
            document.getElementById('estoqueHistorico').style.display = 'block';
            console.log('Hist√≥rico carregado do √≠ndice local (instant√¢neo)');
            return;
          }
        }

        // 2. FALLBACK: Busca no servidor (para itens novos ou n√£o encontrados)
        console.log('Hist√≥rico: buscando no servidor...');
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success && result.data && result.data.rows.length > 0) {
              // Mostra apenas os √∫ltimos 10 registros
              const limitedRows = result.data.rows.slice(0, 10);
              const limitedColors = result.data.colors.slice(0, 10);

              displayTable('estoqueHistoricoContent', {
                headers: result.data.headers,
                rows: limitedRows,
                colors: limitedColors
              });

              document.getElementById('estoqueHistorico').style.display = 'block';
            } else {
              document.getElementById('estoqueHistorico').style.display = 'none';
            }
          })
          .withFailureHandler(function(error) {
            console.error('Erro ao buscar hist√≥rico:', error);
            document.getElementById('estoqueHistorico').style.display = 'none';
          })
          .buscarProduto(item, null, null);
      }, 300); // Reduzido de 800ms para 300ms
    }

    // Load all estoque data for instant client-side filtering
    function loadAllEstoqueData(showFeedback) {
      console.log('=== loadAllEstoqueData INICIADO ===');
      console.log('ShowFeedback:', showFeedback);

      // Mostra indicador de carregamento sempre
      const statusMsg = document.createElement('div');
      statusMsg.id = 'dataLoadingStatus';
      statusMsg.style.cssText = 'position:fixed;top:80px;right:20px;background:#2196f3;color:white;padding:10px 20px;border-radius:4px;box-shadow:0 2px 5px rgba(0,0,0,0.3);z-index:9999;font-size:14px;';
      statusMsg.textContent = 'üîÑ Carregando dados do estoque...';
      document.body.appendChild(statusMsg);

      console.log('Chamando google.script.run.carregarTodosOsDadosEstoque()...');

      google.script.run
        .withSuccessHandler(function(result) {
          console.log('SUCCESS Handler chamado');
          console.log('Result:', result);

          if (result && result.success) {
            allEstoqueData = result.data;
            estoqueHeaders = result.headers;
            console.log('‚úÖ Dados do estoque carregados com sucesso!');
            console.log('Total de registros: ' + (allEstoqueData ? allEstoqueData.length : 0));

            const statusMsg = document.getElementById('dataLoadingStatus');
            if (statusMsg) {
              statusMsg.textContent = '‚úÖ ' + allEstoqueData.length + ' registros carregados!';
              statusMsg.style.background = '#4CAF50';
              setTimeout(() => statusMsg.remove(), 3000);
            }
          } else {
            console.error('‚ùå Erro retornado do servidor:', result ? result.message : 'Resposta vazia');

            const statusMsg = document.getElementById('dataLoadingStatus');
            if (statusMsg) {
              statusMsg.textContent = '‚ùå Erro: ' + (result ? result.message : 'Resposta vazia');
              statusMsg.style.background = '#f44336';
              setTimeout(() => statusMsg.remove(), 5000);
            }
          }
        })
        .withFailureHandler(function(error) {
          console.error('‚ùå FAILURE Handler chamado');
          console.error('Erro completo:', error);
          console.error('Tipo de erro:', typeof error);
          console.error('Mensagem:', error.message);

          const statusMsg = document.getElementById('dataLoadingStatus');
          if (statusMsg) {
            statusMsg.textContent = '‚ùå Falha ao carregar: ' + (error.message || error);
            statusMsg.style.background = '#f44336';
            setTimeout(() => statusMsg.remove(), 5000);
          }

          // Alerta para o usu√°rio
          alert('Erro ao carregar dados do estoque:\n\n' + (error.message || error) + '\n\nVerifique as permiss√µes do script e tente novamente.');
        })
        .carregarTodosOsDadosEstoque();

      console.log('Chamada ao servidor enviada. Aguardando resposta...');
    }

    // Normalize string for search (remove accents, lowercase)
    function normalizeString(str) {
      if (!str) return '';
      return str.toString()
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '');
    }

    // Client-side filter function (INSTANT!)
    function filterEstoqueData(itemFilter, dataInicio, dataFim) {
      if (!allEstoqueData) {
        console.error('Dados do estoque ainda n√£o foram carregados');
        return { success: false, message: 'Dados ainda n√£o carregados. Aguarde...' };
      }

      const itemUpper = itemFilter ? itemFilter.toString().trim().toUpperCase() : '';
      let results = [];

      // Filtra por item e data - CORRESPOND√äNCIA EXATA
      for (let i = 0; i < allEstoqueData.length; i++) {
        const record = allEstoqueData[i];
        const currentItemUpper = record.row[1].toString().trim().toUpperCase(); // Coluna Item

        // Verifica se o item corresponde EXATAMENTE (se filtro foi fornecido)
        if (itemUpper !== '' && currentItemUpper !== itemUpper) {
          continue;
        }

        // Verifica filtro de data
        if (dataInicio && dataFim) {
          const recordDate = new Date(record.date);
          const inicio = new Date(dataInicio);
          const fim = new Date(dataFim);
          inicio.setHours(0, 0, 0, 0);
          fim.setHours(23, 59, 59, 999);

          if (recordDate < inicio || recordDate > fim) {
            continue; // Pula este registro
          }
        }

        results.push(record);
      }

      if (results.length === 0) {
        return { success: false, message: 'Nenhum resultado encontrado' };
      }

      // Ordena do mais novo para o mais antigo
      results.sort(function(a, b) {
        return new Date(b.date).getTime() - new Date(a.date).getTime();
      });

      // Prepara o resultado no formato esperado
      const rows = [];
      const colors = [];
      for (let j = 0; j < results.length; j++) {
        rows.push(results[j].row);
        colors.push(results[j].background);
      }

      return {
        success: true,
        data: {
          headers: estoqueHeaders,
          rows: rows,
          colors: colors
        }
      };
    }

    // Populate autocomplete datalist
    function populateAutocomplete(datalistId, items) {
      const datalist = document.getElementById(datalistId);
      if (!datalist) {
        console.error('Datalist n√£o encontrado:', datalistId);
        return;
      }
      if (!items || !Array.isArray(items)) {
        console.error('Items inv√°lidos para:', datalistId, items);
        return;
      }

      datalist.innerHTML = '';
      items.forEach(item => {
        if (item) {
          const option = document.createElement('option');
          option.value = item;
          datalist.appendChild(option);
        }
      });
    }

    // Autocomplete customizado que filtra do in√≠cio (esquerda para direita)
    function setupCustomAutocomplete(inputId, getDataFn) {
      const input = document.getElementById(inputId);
      if (!input) return;

      // Remove datalist attribute se existir
      input.removeAttribute('list');

      // Cria wrapper e dropdown
      const wrapper = document.createElement('div');
      wrapper.className = 'autocomplete-wrapper';
      input.parentNode.insertBefore(wrapper, input);
      wrapper.appendChild(input);

      const dropdown = document.createElement('div');
      dropdown.className = 'autocomplete-dropdown';
      dropdown.id = inputId + '-dropdown';
      wrapper.appendChild(dropdown);

      let selectedIndex = -1;

      // Filtra e mostra op√ß√µes
      function showOptions() {
        const value = input.value.toUpperCase().trim();
        const data = getDataFn();
        if (!data || data.length === 0) {
          dropdown.classList.remove('show');
          return;
        }

        let filtered;
        if (value === '') {
          // Se n√£o digitou nada, mostra as primeiras 15 op√ß√µes
          filtered = data.slice(0, 15);
        } else {
          // Filtra itens que COME√áAM com o texto digitado
          filtered = data.filter(item =>
            item && item.toUpperCase().startsWith(value)
          ).slice(0, 15); // Limita a 15 resultados
        }

        if (filtered.length === 0) {
          dropdown.classList.remove('show');
          return;
        }

        dropdown.innerHTML = filtered.map((item, idx) =>
          `<div class="autocomplete-option" data-index="${idx}" data-value="${item}">${item}</div>`
        ).join('');
        dropdown.classList.add('show');
        selectedIndex = -1;
      }

      // Seleciona op√ß√£o
      function selectOption(value) {
        input.value = value;
        dropdown.classList.remove('show');
        input.dispatchEvent(new Event('change', { bubbles: true }));
      }

      // Eventos
      input.addEventListener('input', showOptions);
      input.addEventListener('focus', showOptions);

      input.addEventListener('keydown', function(e) {
        const options = dropdown.querySelectorAll('.autocomplete-option');
        if (!dropdown.classList.contains('show') || options.length === 0) return;

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectedIndex = Math.min(selectedIndex + 1, options.length - 1);
          options.forEach((opt, i) => opt.classList.toggle('selected', i === selectedIndex));
          if (options[selectedIndex]) options[selectedIndex].scrollIntoView({ block: 'nearest' });
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectedIndex = Math.max(selectedIndex - 1, 0);
          options.forEach((opt, i) => opt.classList.toggle('selected', i === selectedIndex));
          if (options[selectedIndex]) options[selectedIndex].scrollIntoView({ block: 'nearest' });
        } else if (e.key === 'Enter' && selectedIndex >= 0) {
          e.preventDefault();
          selectOption(options[selectedIndex].dataset.value);
        } else if (e.key === 'Escape') {
          dropdown.classList.remove('show');
        }
      });

      dropdown.addEventListener('click', function(e) {
        if (e.target.classList.contains('autocomplete-option')) {
          selectOption(e.target.dataset.value);
        }
      });

      // Fecha ao clicar fora
      document.addEventListener('click', function(e) {
        if (!wrapper.contains(e.target)) {
          dropdown.classList.remove('show');
        }
      });
    }

    // Inicializa autocompletes customizados ap√≥s carregar dados
    function initCustomAutocompletes() {
      setupCustomAutocomplete('estoqueItem', () => autocompleteData?.items || []);
      setupCustomAutocomplete('estoqueGroup', () => autocompleteData?.groups || []);
      setupCustomAutocomplete('estoqueNF', () => autocompleteData?.nfs || []);
      setupCustomAutocomplete('localizarItem', () => autocompleteData?.items || []);
    }

    // Populate select
    function populateSelect(selectId, items) {
      const select = document.getElementById(selectId);
      const firstOption = select.options[0];
      select.innerHTML = '';
      select.appendChild(firstOption);
      items.forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        option.textContent = item;
        select.appendChild(option);
      });
    }

    // Auto-fill group when item is selected
    document.addEventListener('DOMContentLoaded', function() {
      const itemInput = document.getElementById('estoqueItem');
      if (itemInput) {
        // Auto-fill group when item changes
        itemInput.addEventListener('change', function() {
          const item = this.value;
          if (item) {
            google.script.run
              .withSuccessHandler(function(result) {
                if (result.lastGroup) {
                  document.getElementById('estoqueGroup').value = result.lastGroup;
                }
              })
              .getLastRegistration(item, 0);

            // Show product history
            showProductHistory(item);
          }
        });

        // Show history as user types (with debounce)
        let typingTimer;
        itemInput.addEventListener('input', function() {
          clearTimeout(typingTimer);
          const item = this.value;
          typingTimer = setTimeout(function() {
            if (item && item.length >= 3) {
              showProductHistory(item);
            } else {
              document.getElementById('estoqueHistorico').style.display = 'none';
            }
          }, 500); // Wait 500ms after user stops typing
        });
      }

      // Toggle valor unit√°rio when observa√ß√£o changes
      const obsSelect = document.getElementById('estoqueObs');
      if (obsSelect) {
        obsSelect.addEventListener('change', toggleValorUnitario);
      }
    });

    // Handle Inserir Estoque - Insere e mostra resultado
    function handleInserirEstoque(event) {
      event.preventDefault();

      const formData = {
        item: document.getElementById('estoqueItem').value,
        group: document.getElementById('estoqueGroup').value,
        nf: document.getElementById('estoqueNF').value,
        unidade: document.getElementById('estoqueUnidade').value,
        obs: document.getElementById('estoqueObs').value,
        entrada: document.getElementById('estoqueEntrada').value,
        saida: document.getElementById('estoqueSaida').value,
        valorUnitario: document.getElementById('estoqueValorUnitario').value
      };

      // Valida√ß√£o de campos obrigat√≥rios
      if (!formData.item.trim()) {
        showMessage('estoqueMessage', 'Informe o produto.', 'error');
        document.getElementById('estoqueItem').focus();
        return false;
      }

      if (!formData.group.trim()) {
        showMessage('estoqueMessage', 'Informe o grupo.', 'error');
        document.getElementById('estoqueGroup').focus();
        return false;
      }

      if (!formData.unidade) {
        showMessage('estoqueMessage', 'Selecione a unidade.', 'error');
        document.getElementById('estoqueUnidade').focus();
        return false;
      }

      // Validation
      const entrada = parseFloat(formData.entrada) || 0;
      const saida = parseFloat(formData.saida) || 0;

      if (entrada > 0 && saida > 0) {
        showMessage('estoqueMessage', 'N√£o √© poss√≠vel ter entrada e sa√≠da ao mesmo tempo.', 'error');
        return false;
      }

      if (entrada === 0 && saida === 0) {
        showMessage('estoqueMessage', 'Informe uma entrada ou sa√≠da.', 'error');
        return false;
      }

      // Valida√ß√£o de valor unit√°rio (regra: obrigat√≥rio se obs ‚â† "ATUALIZA√á√ÉO")
      const valorUnitario = parseFloat(formData.valorUnitario) || 0;
      if (formData.obs.toUpperCase() !== 'ATUALIZA√á√ÉO' && valorUnitario <= 0) {
        showMessage('estoqueMessage', 'Valor unit√°rio √© obrigat√≥rio (exceto quando Obs = ATUALIZA√á√ÉO).', 'error');
        return false;
      }

      // Verifica se √© item novo
      const nomeItemUpper = formData.item.trim().toUpperCase();
      const isItemNovo = !(autocompleteData && autocompleteData.items &&
        autocompleteData.items.some(item => item.toUpperCase() === nomeItemUpper));

      // Mostra loading enquanto processa
      showLoading('Processando lan√ßamento...');

      // Envia para servidor e AGUARDA confirma√ß√£o antes de mostrar resultado
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();

          if (result.success) {
            // Preenche modal de resultado com dados CONFIRMADOS do servidor
            document.getElementById('resultProduto').textContent = formData.item;
            document.getElementById('resultGrupo').textContent = formData.group || '-';
            document.getElementById('resultNF').textContent = formData.nf || '-';
            document.getElementById('resultObs').textContent = formData.obs || '-';

            document.getElementById('resultTipo').innerHTML = entrada > 0 ?
              '<span style="color: #28a745; font-weight: bold;">ENTRADA</span>' :
              '<span style="color: #dc3545; font-weight: bold;">SA√çDA</span>';
            document.getElementById('resultQtd').textContent = entrada > 0 ? entrada : saida;

            // Mostra saldos CONFIRMADOS do servidor
            const saldoAnterior = result.saldoAnterior !== undefined ? result.saldoAnterior : 0;
            const novoSaldo = result.novoSaldo !== undefined ? result.novoSaldo : 0;
            document.getElementById('resultSaldoAnterior').textContent = saldoAnterior;
            document.getElementById('resultNovoSaldo').textContent = novoSaldo;

            // Mostra aviso de item novo
            document.getElementById('avisoItemNovoModal').style.display = isItemNovo ? 'block' : 'none';

            // Mostra aviso de status do produto (VERMELHO ou AMARELO)
            const avisoStatus = document.getElementById('avisoStatusProduto');
            if (result.warning && result.message) {
              avisoStatus.style.display = 'block';

              // Define a cor baseado no tipo de aviso
              if (result.message.includes('DESATUALIZADO') || result.message.includes('20 DIAS')) {
                avisoStatus.innerHTML = `
                  <div style="font-size: 2.5rem; margin-bottom: 10px; animation: pulse 1.5s infinite;">üö®</div>
                  <div style="font-size: 1.3rem; margin-bottom: 10px; text-transform: uppercase;">‚ö†Ô∏è ATEN√á√ÉO URGENTE ‚ö†Ô∏è</div>
                  <div style="font-size: 1.1rem; margin-bottom: 15px; line-height: 1.5;">
                    <strong>PRODUTO DESATUALIZADO!</strong><br>
                    √öltima atualiza√ß√£o h√° mais de 20 dias
                  </div>
                  <div style="font-size: 1.2rem; background: #d32f2f; color: white; padding: 15px; border-radius: 6px; margin-top: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                    ‚ö° A√á√ÉO NECESS√ÅRIA: ATUALIZAR ESTOQUE URGENTE! ‚ö°<br>
                    <span style="font-size: 0.9rem; margin-top: 8px; display: block;">
                      Realize uma contagem f√≠sica e registre uma atualiza√ß√£o completa do saldo
                    </span>
                  </div>
                `;
                avisoStatus.style.background = '#ffebee';
                avisoStatus.style.border = '4px solid #f44336';
                avisoStatus.style.color = '#c62828';
                avisoStatus.style.boxShadow = '0 8px 16px rgba(244, 67, 54, 0.3)';
              } else if (result.message.includes('ENTRADA')) {
                avisoStatus.innerHTML = `
                  <div style="font-size: 2rem; margin-bottom: 8px;">üì¶</div>
                  <div style="font-size: 1.1rem; margin-bottom: 10px;"><strong>‚ö†Ô∏è ENTRADA DE ESTOQUE REGISTRADA!</strong></div>
                  <div style="font-size: 0.95rem; line-height: 1.5;">
                    √â necess√°rio atualizar o estoque deste item para evitar furos de estoque.<br>
                    <strong>Realize uma contagem f√≠sica e registre uma atualiza√ß√£o completa do saldo.</strong>
                  </div>
                `;
                avisoStatus.style.background = '#fff3cd';
                avisoStatus.style.border = '3px solid #ffc107';
                avisoStatus.style.color = '#856404';
                avisoStatus.style.boxShadow = '0 4px 8px rgba(255, 193, 7, 0.2)';
              }
            } else {
              avisoStatus.style.display = 'none';
            }

            // Abre modal de resultado AP√ìS confirma√ß√£o do servidor
            document.getElementById('modalResultadoEstoque').classList.add('show');

            // Reseta formul√°rio
            resetEstoqueForm();

            // Atualiza caches em background
            clearClientCache();
            loadDashboardData();
            loadAutocompleteData();
          } else {
            showMessage('estoqueMessage', result.message || 'Erro ao inserir estoque', 'error');
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showMessage('estoqueMessage', 'Erro: ' + error.message, 'error');
        })
        .processEstoqueWebApp(formData);

      return false;
    }

    // Fecha modal de resultado e volta para inserir outro item
    function fecharModalResultado() {
      document.getElementById('modalResultadoEstoque').classList.remove('show');
      // Garante que o formul√°rio est√° limpo
      resetEstoqueForm();
    }

    // Reset estoque form - limpa todos os campos completamente
    function resetEstoqueForm() {
      // Limpa campos de texto
      document.getElementById('estoqueItem').value = '';
      document.getElementById('estoqueGroup').value = '';
      document.getElementById('estoqueNF').value = '';

      // Reseta selects para primeira op√ß√£o (vazia)
      const unidadeSelect = document.getElementById('estoqueUnidade');
      if (unidadeSelect) unidadeSelect.selectedIndex = 0;

      const obsSelect = document.getElementById('estoqueObs');
      if (obsSelect) obsSelect.selectedIndex = 0;

      // Reseta valores num√©ricos
      document.getElementById('estoqueEntrada').value = '0';
      document.getElementById('estoqueSaida').value = '0';
      document.getElementById('estoqueValorUnitario').value = '';

      // Esconde campos condicionais
      document.getElementById('valorUnitarioGroup').style.display = 'none';
      document.getElementById('estoqueHistorico').style.display = 'none';

      // Limpa avisos de item novo
      document.getElementById('avisoItemNovoEstoque').style.display = 'none';
      document.getElementById('avisoItemNovoSmall').style.display = 'none';

      // Reseta estilo do grupo
      const grupoContainer = document.getElementById('estoqueGroupContainer');
      grupoContainer.style.background = '';
      grupoContainer.style.padding = '';
      grupoContainer.style.border = '';

      // Foca no campo de item
      document.getElementById('estoqueItem').focus();
    }

    // Volta da √°rea de resultados para o formul√°rio de inser√ß√£o
    function voltarParaFormulario() {
      document.getElementById('estoqueResultArea').style.display = 'none';
      document.getElementById('estoqueFormArea').style.display = 'block';
      document.getElementById('estoqueItem').focus();
    }

    // ========== FUN√á√ïES INSERIR NF (M√öLTIPLOS ITENS) ==========
    let nfItemCounter = 0;

    // Adicionar item na lista de NF
    function adicionarItemNF() {
      nfItemCounter++;
      const container = document.getElementById('nfItensContainer');
      const itemDiv = document.createElement('div');
      itemDiv.id = 'nfItem-' + nfItemCounter;
      itemDiv.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto; gap: 8px; margin-bottom: 10px; padding: 10px; background: white; border-radius: 4px; align-items: end;';
      itemDiv.innerHTML = `
        <div class="form-group" style="margin-bottom: 0;">
          <label style="font-size: 0.75rem;">Item *</label>
          <input type="text" class="nf-item-nome" list="nfItemDatalist-${nfItemCounter}" required style="padding: 6px;" placeholder="Nome do item" onblur="verificarItemNovo(this, ${nfItemCounter})">
          <datalist id="nfItemDatalist-${nfItemCounter}"></datalist>
          <small class="nf-item-novo-aviso" style="display: none; color: #dc3545; font-size: 0.7rem;">‚ö†Ô∏è Item NOVO!</small>
        </div>
        <div class="form-group grupo-field-novo" id="grupoField-${nfItemCounter}" style="margin-bottom: 0;">
          <label style="font-size: 0.75rem;">Grupo *</label>
          <select class="nf-item-grupo" style="padding: 6px;">
            <option value="">Selecione...</option>
          </select>
        </div>
        <div class="form-group" style="margin-bottom: 0;">
          <label style="font-size: 0.75rem;">Pre√ßo *</label>
          <input type="number" class="nf-item-preco" step="0.01" min="0" required style="padding: 6px;" placeholder="0.00">
        </div>
        <div class="form-group" style="margin-bottom: 0;">
          <label style="font-size: 0.75rem;">Lote</label>
          <input type="text" class="nf-item-lote" style="padding: 6px;" placeholder="Lote">
        </div>
        <div class="form-group" style="margin-bottom: 0;">
          <label style="font-size: 0.75rem;">Entrada *</label>
          <input type="number" class="nf-item-entrada" step="0.01" min="0.01" required style="padding: 6px;" placeholder="Qtd">
        </div>
        <button type="button" class="btn btn-danger" onclick="removerItemNF(${nfItemCounter})" style="padding: 6px 10px; height: fit-content;">‚úï</button>
      `;
      container.appendChild(itemDiv);

      // Popula datalist do item
      const datalist = document.getElementById('nfItemDatalist-' + nfItemCounter);
      if (autocompleteData && autocompleteData.items) {
        autocompleteData.items.forEach(item => {
          const option = document.createElement('option');
          option.value = item;
          datalist.appendChild(option);
        });
      }

      // Popula select de grupos
      const grupoSelect = itemDiv.querySelector('.nf-item-grupo');
      if (autocompleteData && autocompleteData.groups) {
        autocompleteData.groups.forEach(grupo => {
          const option = document.createElement('option');
          option.value = grupo;
          option.textContent = grupo;
          grupoSelect.appendChild(option);
        });
      }
    }

    // Timeout para verifica√ß√£o de item novo na NF
    let verificarItemNFTimeout = {};

    // Verifica se o item √© novo (n√£o existe na base)
    // Usa delay para aguardar o usu√°rio terminar de selecionar do autocomplete
    function verificarItemNovo(input, itemId) {
      // Limpa timeout anterior para este item
      clearTimeout(verificarItemNFTimeout[itemId]);

      // Aguarda 400ms ap√≥s o blur para verificar
      verificarItemNFTimeout[itemId] = setTimeout(function() {
        const nomeItem = input.value.trim().toUpperCase();
        const grupoField = document.getElementById('grupoField-' + itemId);
        const avisoNovo = input.parentElement.querySelector('.nf-item-novo-aviso');

        if (!nomeItem) {
          grupoField.classList.remove('show');
          avisoNovo.style.display = 'none';
          return;
        }

        // Verifica se item existe na lista de autocomplete
        const itemExiste = autocompleteData && autocompleteData.items &&
          autocompleteData.items.some(item => item.toUpperCase() === nomeItem);

        if (!itemExiste) {
          grupoField.classList.add('show');
          avisoNovo.style.display = 'block';
        } else {
          grupoField.classList.remove('show');
          avisoNovo.style.display = 'none';
        }
      }, 400);
    }

    // Verifica se um item existe na base
    function itemExisteNaBase(nomeItem) {
      if (!nomeItem) return false;
      const nomeUpper = nomeItem.trim().toUpperCase();
      return autocompleteData && autocompleteData.items &&
        autocompleteData.items.some(item => item.toUpperCase() === nomeUpper);
    }

    // Remover item da lista de NF
    function removerItemNF(id) {
      const itemDiv = document.getElementById('nfItem-' + id);
      if (itemDiv) {
        itemDiv.remove();
      }
    }

    // Limpar formul√°rio NF
    function limparFormNF() {
      document.getElementById('nfNumero').value = '';
      document.getElementById('nfPedido').value = '';
      document.getElementById('nfUnidade').selectedIndex = 0;
      document.getElementById('nfObs').selectedIndex = 0;
      document.getElementById('nfItensContainer').innerHTML = '';
      nfItemCounter = 0;
      showMessage('nfMessage', '', '');
    }

    // Voltar para formul√°rio NF ap√≥s inser√ß√£o
    function voltarParaNF() {
      document.getElementById('nfResultArea').style.display = 'none';
      document.getElementById('nfFormArea').style.display = 'block';
      limparFormNF();
    }

    // Vari√°vel global para armazenar itens pendentes de confirma√ß√£o
    let itensParaConfirmar = [];
    let itensConfirmados = new Set();

    // Processar inser√ß√£o de NF com m√∫ltiplos itens - Abre modal de confirma√ß√£o
    function handleInserirNF() {
      // Validar campos globais
      const nfNumero = document.getElementById('nfNumero').value.trim();
      const nfPedido = document.getElementById('nfPedido').value.trim();
      const nfUnidade = document.getElementById('nfUnidade').value;
      const nfObs = document.getElementById('nfObs').value;

      if (!nfNumero) {
        showMessage('nfMessage', 'Informe o n√∫mero da NF', 'error');
        return;
      }
      if (!nfUnidade) {
        showMessage('nfMessage', 'Selecione a unidade', 'error');
        return;
      }

      // Coletar itens
      const container = document.getElementById('nfItensContainer');
      const itemDivs = container.querySelectorAll('[id^="nfItem-"]');

      if (itemDivs.length === 0) {
        showMessage('nfMessage', 'Adicione pelo menos um item', 'error');
        return;
      }

      itensParaConfirmar = [];
      itensConfirmados = new Set();
      let hasError = false;
      let temItemNovo = false;

      itemDivs.forEach((div, index) => {
        const nome = div.querySelector('.nf-item-nome').value.trim().toUpperCase();
        const preco = parseFloat(div.querySelector('.nf-item-preco').value) || 0;
        const lote = div.querySelector('.nf-item-lote').value.trim();
        const entrada = parseFloat(div.querySelector('.nf-item-entrada').value) || 0;
        const grupoSelect = div.querySelector('.nf-item-grupo');
        const grupoSelecionado = grupoSelect ? grupoSelect.value : '';

        if (!nome) {
          showMessage('nfMessage', `Item ${index + 1}: Nome do item √© obrigat√≥rio`, 'error');
          hasError = true;
          return;
        }
        if (preco <= 0) {
          showMessage('nfMessage', `Item ${index + 1} (${nome}): Pre√ßo √© obrigat√≥rio`, 'error');
          hasError = true;
          return;
        }
        if (entrada <= 0) {
          showMessage('nfMessage', `Item ${index + 1} (${nome}): Entrada √© obrigat√≥ria`, 'error');
          hasError = true;
          return;
        }

        // Verifica se √© item novo
        const isNovoItem = !itemExisteNaBase(nome);

        // Se for item novo, exige grupo
        if (isNovoItem && !grupoSelecionado) {
          showMessage('nfMessage', `Item ${index + 1} (${nome}): Item NOVO precisa de um Grupo selecionado`, 'error');
          hasError = true;
          return;
        }

        if (isNovoItem) {
          temItemNovo = true;
        }

        // Concatena NF + Pedido + Lote
        let nfConcatenado = nfNumero;
        if (nfPedido) nfConcatenado += ' ' + nfPedido;
        if (lote) nfConcatenado += ' ' + lote;

        itensParaConfirmar.push({
          index: index + 1,
          item: nome,
          unidade: nfUnidade,
          nf: nfConcatenado,
          obs: nfObs,
          entrada: entrada,
          saida: 0,
          valorUnitario: preco,
          lote: lote,
          grupo: grupoSelecionado,
          isNovo: isNovoItem
        });
      });

      if (hasError) return;

      // Mostra loading enquanto prepara modal de confirma√ß√£o
      showLoading('Preparando confirma√ß√£o...');

      // Pequeno delay para garantir que o loading seja exibido
      setTimeout(() => {
        // Abre modal de confirma√ß√£o
        abrirModalConfirmacao(nfNumero, nfPedido, nfUnidade, nfObs, temItemNovo);
      }, 100);
    }

    // Abre o modal de confirma√ß√£o com os itens
    function abrirModalConfirmacao(nfNumero, nfPedido, nfUnidade, nfObs, temItemNovo) {
      // Mostra/esconde aviso de itens novos
      document.getElementById('avisoItensNovos').style.display = temItemNovo ? 'block' : 'none';

      // Info da NF
      let infoHtml = `<strong>NF:</strong> ${nfNumero}`;
      if (nfPedido) infoHtml += ` | <strong>Pedido:</strong> ${nfPedido}`;
      infoHtml += ` | <strong>Unidade:</strong> ${nfUnidade}`;
      if (nfObs) infoHtml += ` | <strong>Obs:</strong> ${nfObs}`;
      document.getElementById('infoNFModal').innerHTML = infoHtml;

      // Lista de itens
      const listaContainer = document.getElementById('listaItensConfirmacao');
      let listaHtml = '';

      itensParaConfirmar.forEach((item, idx) => {
        const classeNovo = item.isNovo ? 'item-novo' : '';
        const badgeNovo = item.isNovo ? '<span class="item-novo-badge">NOVO</span>' : '';
        const grupoDisplay = item.isNovo ? item.grupo : '(existente)';

        listaHtml += `
          <div class="confirm-item-row ${classeNovo}" data-index="${idx}">
            <span class="item-index">${item.index}</span>
            <span class="item-nome">${item.item}${badgeNovo}</span>
            <span>${grupoDisplay}</span>
            <span>R$ ${item.valorUnitario.toFixed(2)}</span>
            <span>${item.lote || '-'}</span>
            <span>${item.entrada}</span>
            <button type="button" class="btn-ok-item" onclick="confirmarItem(${idx})" id="btnOkItem-${idx}">OK</button>
          </div>
        `;
      });

      listaContainer.innerHTML = listaHtml;

      // Atualiza contador
      document.getElementById('totalConfirmados').textContent = '0';
      document.getElementById('totalItensNF').textContent = itensParaConfirmar.length;
      document.getElementById('btnConfirmarInsercaoFinal').disabled = true;

      // Esconde loading e mostra modal
      hideLoading();
      document.getElementById('modalConfirmacaoNF').classList.add('show');
    }

    // Confirma um item individual
    function confirmarItem(idx) {
      const btn = document.getElementById('btnOkItem-' + idx);
      btn.classList.add('confirmed');
      btn.disabled = true;
      btn.textContent = 'OK';

      itensConfirmados.add(idx);

      // Atualiza contador
      document.getElementById('totalConfirmados').textContent = itensConfirmados.size;

      // Habilita bot√£o final se todos confirmados
      if (itensConfirmados.size === itensParaConfirmar.length) {
        document.getElementById('btnConfirmarInsercaoFinal').disabled = false;
      }
    }

    // Fecha modal de confirma√ß√£o
    function fecharModalConfirmacao() {
      document.getElementById('modalConfirmacaoNF').classList.remove('show');
    }

    // Volta para edi√ß√£o do formul√°rio
    function voltarParaEdicao() {
      fecharModalConfirmacao();
      showMessage('nfMessage', 'Ajuste os dados e clique em Confirmar novamente', 'info');
    }

    // Confirma inser√ß√£o final e envia para o servidor
    function confirmarInsercaoFinal() {
      if (itensConfirmados.size !== itensParaConfirmar.length) {
        alert('Confirme todos os itens antes de prosseguir');
        return;
      }

      const nfNumero = document.getElementById('nfNumero').value.trim();

      // Prepara itens para envio
      const itensParaEnviar = itensParaConfirmar.map(item => ({
        item: item.item,
        unidade: item.unidade,
        nf: item.nf,
        obs: item.obs,
        entrada: item.entrada,
        saida: item.saida,
        valorUnitario: item.valorUnitario,
        grupo: item.grupo || '' // Envia grupo para itens novos
      }));

      fecharModalConfirmacao();

      // Mostra loading durante processamento
      showLoading('Inserindo ' + itensParaEnviar.length + ' itens no sistema...');

      // Envia para servidor
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            document.getElementById('nfFormArea').style.display = 'none';
            document.getElementById('nfResultArea').style.display = 'block';

            // Mostra mensagem e tabela de itens inseridos
            document.getElementById('nfResultMessage').innerHTML =
              '<strong>' + itensParaEnviar.length + '</strong> item(ns) inserido(s) com sucesso na NF <strong>' + nfNumero + '</strong>';

            // Mostra tabela com os itens inseridos
            mostrarTabelaItensInseridos(itensParaEnviar);

            // Atualiza cache e autocomplete
            clearClientCache();
            loadDashboardData();
            loadAutocompleteData();

            showMessage('nfMessage', '', '');
          } else {
            showMessage('nfMessage', result.message || 'Erro ao inserir itens', 'error');
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showMessage('nfMessage', 'Erro: ' + error.message, 'error');
        })
        .processMultipleEstoqueItemsWithGroup(itensParaEnviar);
    }

    // Mostra tabela com os itens que foram inseridos
    function mostrarTabelaItensInseridos(itens) {
      const container = document.getElementById('nfResultTable');
      let html = `
        <table class="data-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Item</th>
              <th>Grupo</th>
              <th>Unidade</th>
              <th>NF</th>
              <th>Pre√ßo</th>
              <th>Entrada</th>
            </tr>
          </thead>
          <tbody>
      `;

      itens.forEach((item, idx) => {
        html += `
          <tr>
            <td>${idx + 1}</td>
            <td>${item.item}</td>
            <td>${item.grupo || '-'}</td>
            <td>${item.unidade}</td>
            <td>${item.nf}</td>
            <td>R$ ${item.valorUnitario.toFixed(2)}</td>
            <td>${item.entrada}</td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // ========== FUN√á√ïES LAN√áAMENTO EM LOTE ==========
    let loteItemCounter = 0;
    let itensParaConfirmarLote = [];
    let itensConfirmadosLote = new Set();

    // Abre a √°rea de lan√ßamento em lote
    function abrirLancamentoLote() {
      document.getElementById('estoqueFormArea').style.display = 'none';
      document.getElementById('estoqueResultArea').style.display = 'none';
      document.getElementById('estoqueLoteResultArea').style.display = 'none';
      document.getElementById('estoqueLoteArea').style.display = 'block';

      // Popula os selects do lote
      populateLoteSelects();

      // Adiciona o primeiro item automaticamente
      if (document.getElementById('loteItensContainer').children.length === 0) {
        adicionarItemLote();
      }
    }

    // Popula os selects do formul√°rio de lote
    function populateLoteSelects() {
      if (!autocompleteData) return;

      // Grupo
      const grupoSelect = document.getElementById('loteGrupo');
      if (grupoSelect.options.length <= 1 && autocompleteData.groups) {
        autocompleteData.groups.forEach(grupo => {
          const option = document.createElement('option');
          option.value = grupo;
          option.textContent = grupo;
          grupoSelect.appendChild(option);
        });
      }

      // Unidade
      const unidadeSelect = document.getElementById('loteUnidade');
      if (unidadeSelect.options.length <= 1 && autocompleteData.medidas) {
        autocompleteData.medidas.forEach(medida => {
          const option = document.createElement('option');
          option.value = medida;
          option.textContent = medida;
          unidadeSelect.appendChild(option);
        });
      }

      // Observa√ß√£o
      const obsSelect = document.getElementById('loteObs');
      if (obsSelect.options.length <= 1 && autocompleteData.observacoes) {
        autocompleteData.observacoes.forEach(obs => {
          const option = document.createElement('option');
          option.value = obs;
          option.textContent = obs;
          obsSelect.appendChild(option);
        });
      }
    }

    // Volta para o formul√°rio de estoque simples
    function voltarParaEstoqueSimples() {
      document.getElementById('estoqueLoteArea').style.display = 'none';
      document.getElementById('estoqueLoteResultArea').style.display = 'none';
      document.getElementById('estoqueFormArea').style.display = 'block';
      limparFormLote();
    }

    // Adiciona um item na lista do lote
    function adicionarItemLote() {
      loteItemCounter++;
      const container = document.getElementById('loteItensContainer');
      const operacao = document.querySelector('input[name="loteOperacao"]:checked').value;
      const labelQtd = operacao === 'entrada' ? 'Entrada *' : 'Sa√≠da *';

      const itemDiv = document.createElement('div');
      itemDiv.id = 'loteItem-' + loteItemCounter;
      itemDiv.className = 'lote-item-row';
      itemDiv.innerHTML = `
        <div class="form-group" style="margin-bottom: 0;">
          <label style="font-size: 0.75rem;">Produto *</label>
          <input type="text" class="lote-item-nome" list="loteItemDatalist-${loteItemCounter}" required style="padding: 6px;" placeholder="Nome do produto" onblur="verificarItemNovoLote(this, ${loteItemCounter})">
          <datalist id="loteItemDatalist-${loteItemCounter}"></datalist>
          <small class="lote-item-novo-aviso" style="display: none; color: #dc3545; font-size: 0.7rem;">‚ö†Ô∏è Item NOVO!</small>
        </div>
        <div class="form-group" style="margin-bottom: 0;">
          <label style="font-size: 0.75rem;">${labelQtd}</label>
          <input type="number" class="lote-item-qtd" step="0.01" min="0.01" required style="padding: 6px;" placeholder="Qtd">
        </div>
        <button type="button" class="btn btn-danger" onclick="removerItemLote(${loteItemCounter})" style="padding: 6px 10px; height: fit-content;">‚úï</button>
      `;
      container.appendChild(itemDiv);

      // Popula datalist do item
      const datalist = document.getElementById('loteItemDatalist-' + loteItemCounter);
      if (autocompleteData && autocompleteData.items) {
        autocompleteData.items.forEach(item => {
          const option = document.createElement('option');
          option.value = item;
          datalist.appendChild(option);
        });
      }
    }

    // Timeout para verifica√ß√£o de item novo no lote
    let verificarItemLoteTimeout = {};

    // Verifica se o item √© novo no lote
    function verificarItemNovoLote(input, itemId) {
      clearTimeout(verificarItemLoteTimeout[itemId]);

      verificarItemLoteTimeout[itemId] = setTimeout(function() {
        const nomeItem = input.value.trim().toUpperCase();
        const avisoNovo = input.parentElement.querySelector('.lote-item-novo-aviso');

        if (!nomeItem) {
          avisoNovo.style.display = 'none';
          return;
        }

        const itemExiste = autocompleteData && autocompleteData.items &&
          autocompleteData.items.some(item => item.toUpperCase() === nomeItem);

        if (!itemExiste) {
          avisoNovo.style.display = 'block';
        } else {
          avisoNovo.style.display = 'none';
        }
      }, 400);
    }

    // Remove item do lote
    function removerItemLote(id) {
      const itemDiv = document.getElementById('loteItem-' + id);
      if (itemDiv) {
        itemDiv.remove();
      }
    }

    // Limpa formul√°rio do lote
    function limparFormLote() {
      document.querySelector('input[name="loteOperacao"][value="entrada"]').checked = true;
      document.getElementById('loteGrupo').selectedIndex = 0;
      document.getElementById('loteUnidade').selectedIndex = 0;
      document.getElementById('loteObs').selectedIndex = 0;
      document.getElementById('loteNF').value = '';
      document.getElementById('loteItensContainer').innerHTML = '';
      loteItemCounter = 0;
      showMessage('estoqueLoteMessage', '', '');
    }

    // Processa inser√ß√£o do lote - abre modal de confirma√ß√£o
    function handleInserirLote() {
      // Validar campos globais
      const operacao = document.querySelector('input[name="loteOperacao"]:checked').value;
      const grupo = document.getElementById('loteGrupo').value;
      const unidade = document.getElementById('loteUnidade').value;
      const obs = document.getElementById('loteObs').value;
      const nf = document.getElementById('loteNF').value.trim();

      if (!grupo) {
        showMessage('estoqueLoteMessage', 'Selecione o grupo', 'error');
        return;
      }
      if (!unidade) {
        showMessage('estoqueLoteMessage', 'Selecione a unidade', 'error');
        return;
      }

      // Coletar itens
      const container = document.getElementById('loteItensContainer');
      const itemDivs = container.querySelectorAll('[id^="loteItem-"]');

      if (itemDivs.length === 0) {
        showMessage('estoqueLoteMessage', 'Adicione pelo menos um item', 'error');
        return;
      }

      itensParaConfirmarLote = [];
      itensConfirmadosLote = new Set();
      let hasError = false;
      let temItemNovo = false;

      itemDivs.forEach((div, index) => {
        const nome = div.querySelector('.lote-item-nome').value.trim().toUpperCase();
        const qtd = parseFloat(div.querySelector('.lote-item-qtd').value) || 0;

        if (!nome) {
          showMessage('estoqueLoteMessage', `Item ${index + 1}: Nome do produto √© obrigat√≥rio`, 'error');
          hasError = true;
          return;
        }
        if (qtd <= 0) {
          showMessage('estoqueLoteMessage', `Item ${index + 1} (${nome}): Quantidade √© obrigat√≥ria`, 'error');
          hasError = true;
          return;
        }

        const isNovoItem = !itemExisteNaBase(nome);
        if (isNovoItem) {
          temItemNovo = true;
        }

        itensParaConfirmarLote.push({
          index: index + 1,
          item: nome,
          unidade: unidade,
          nf: nf,
          obs: obs,
          entrada: operacao === 'entrada' ? qtd : 0,
          saida: operacao === 'saida' ? qtd : 0,
          valorUnitario: 0,
          grupo: grupo,
          isNovo: isNovoItem,
          qtd: qtd
        });
      });

      if (hasError) return;

      // Mostra loading enquanto prepara modal de confirma√ß√£o
      showLoading('Preparando confirma√ß√£o do lote...');

      // Pequeno delay para garantir que o loading seja exibido
      setTimeout(() => {
        // Abre modal de confirma√ß√£o
        abrirModalConfirmacaoLote(operacao, grupo, unidade, obs, nf, temItemNovo);
      }, 100);
    }

    // Abre o modal de confirma√ß√£o do lote
    function abrirModalConfirmacaoLote(operacao, grupo, unidade, obs, nf, temItemNovo) {
      // Mostra/esconde aviso de itens novos
      document.getElementById('avisoItensNovosLote').style.display = temItemNovo ? 'block' : 'none';

      // Info do Lote
      const tipoOp = operacao === 'entrada' ? 'üì• ENTRADA' : 'üì§ SA√çDA';
      const corOp = operacao === 'entrada' ? '#28a745' : '#dc3545';
      let infoHtml = `<strong style="color: ${corOp};">${tipoOp}</strong>`;
      infoHtml += ` | <strong>Grupo:</strong> ${grupo}`;
      infoHtml += ` | <strong>Unidade:</strong> ${unidade}`;
      if (nf) infoHtml += ` | <strong>Pedido/OC:</strong> ${nf}`;
      if (obs) infoHtml += ` | <strong>Obs:</strong> ${obs}`;
      document.getElementById('infoLoteModal').innerHTML = infoHtml;

      // Lista de itens com placeholders para saldo
      const listaContainer = document.getElementById('listaItensConfirmacaoLote');
      let listaHtml = '';

      itensParaConfirmarLote.forEach((item, idx) => {
        const classeNovo = item.isNovo ? 'item-novo' : '';
        const badgeNovo = item.isNovo ? '<span class="item-novo-badge">NOVO</span>' : '';

        listaHtml += `
          <div class="confirm-item-row-lote ${classeNovo}" data-index="${idx}">
            <span class="item-index">${item.index}</span>
            <span class="item-nome">${item.item}${badgeNovo}</span>
            <span>${item.qtd}</span>
            <span id="saldoAtualLote-${idx}" style="color: #666;">...</span>
            <span id="saldoFinalLote-${idx}" style="font-weight: bold; color: #28a745;">...</span>
            <button type="button" class="btn-ok-item" onclick="confirmarItemLote(${idx})" id="btnOkItemLote-${idx}">OK</button>
          </div>
        `;
      });

      listaContainer.innerHTML = listaHtml;

      // Atualiza contador
      document.getElementById('totalConfirmadosLote').textContent = '0';
      document.getElementById('totalItensLote').textContent = itensParaConfirmarLote.length;
      document.getElementById('btnConfirmarInsercaoFinalLote').disabled = true;

      // Mostra modal (mant√©m loading at√© carregar saldos)
      document.getElementById('modalConfirmacaoLote').classList.add('show');

      // Busca saldos de todos os itens
      carregarSaldosLote(operacao);
    }

    // Carrega os saldos de todos os itens do lote
    function carregarSaldosLote(operacao) {
      const itensNomes = itensParaConfirmarLote.map(item => item.item);

      // Busca saldos do servidor
      google.script.run
        .withSuccessHandler(function(saldos) {
          // saldos √© um objeto { "ITEM1": saldo1, "ITEM2": saldo2, ... }
          itensParaConfirmarLote.forEach((item, idx) => {
            const saldoAtual = saldos[item.item] || 0;
            const saldoFinal = operacao === 'entrada'
              ? saldoAtual + item.qtd
              : saldoAtual - item.qtd;

            // Atualiza item com saldos
            item.saldoAtual = saldoAtual;
            item.saldoFinal = saldoFinal;

            // Atualiza display
            const spanAtual = document.getElementById('saldoAtualLote-' + idx);
            const spanFinal = document.getElementById('saldoFinalLote-' + idx);

            if (spanAtual) spanAtual.textContent = saldoAtual.toFixed(2);
            if (spanFinal) {
              spanFinal.textContent = saldoFinal.toFixed(2);
              // Cor vermelha se saldo final ficar negativo
              if (saldoFinal < 0) {
                spanFinal.style.color = '#dc3545';
              }
            }
          });
          // Esconde loading ap√≥s carregar saldos
          hideLoading();
        })
        .withFailureHandler(function(error) {
          console.error('Erro ao carregar saldos:', error);
          // Em caso de erro, mostra "?" nos campos
          itensParaConfirmarLote.forEach((item, idx) => {
            const spanAtual = document.getElementById('saldoAtualLote-' + idx);
            const spanFinal = document.getElementById('saldoFinalLote-' + idx);
            if (spanAtual) spanAtual.textContent = '?';
            if (spanFinal) spanFinal.textContent = '?';
          });
          // Esconde loading mesmo em caso de erro
          hideLoading();
        })
        .getMultipleSaldos(itensNomes);
    }

    // Confirma um item individual do lote
    function confirmarItemLote(idx) {
      const btn = document.getElementById('btnOkItemLote-' + idx);
      btn.classList.add('confirmed');
      btn.disabled = true;
      btn.textContent = 'OK';

      itensConfirmadosLote.add(idx);

      // Atualiza contador
      document.getElementById('totalConfirmadosLote').textContent = itensConfirmadosLote.size;

      // Habilita bot√£o final se todos confirmados
      if (itensConfirmadosLote.size === itensParaConfirmarLote.length) {
        document.getElementById('btnConfirmarInsercaoFinalLote').disabled = false;
      }
    }

    // Fecha modal de confirma√ß√£o do lote
    function fecharModalConfirmacaoLote() {
      document.getElementById('modalConfirmacaoLote').classList.remove('show');
    }

    // Volta para edi√ß√£o do formul√°rio do lote
    function voltarParaEdicaoLote() {
      fecharModalConfirmacaoLote();
      showMessage('estoqueLoteMessage', 'Ajuste os dados e clique em Confirmar novamente', 'info');
    }

    // Confirma inser√ß√£o final do lote e envia para o servidor
    function confirmarInsercaoFinalLote() {
      if (itensConfirmadosLote.size !== itensParaConfirmarLote.length) {
        alert('Confirme todos os itens antes de prosseguir');
        return;
      }

      const operacao = document.querySelector('input[name="loteOperacao"]:checked').value;

      // Prepara itens para envio
      const itensParaEnviar = itensParaConfirmarLote.map(item => ({
        item: item.item,
        unidade: item.unidade,
        nf: item.nf,
        obs: item.obs,
        entrada: item.entrada,
        saida: item.saida,
        valorUnitario: item.valorUnitario,
        grupo: item.grupo
      }));

      fecharModalConfirmacaoLote();

      // Mostra loading durante processamento
      showLoading('Processando ' + itensParaEnviar.length + ' itens em lote...');

      // Envia para servidor com retorno de saldos
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            document.getElementById('estoqueLoteArea').style.display = 'none';
            document.getElementById('estoqueLoteResultArea').style.display = 'block';

            const tipoOp = operacao === 'entrada' ? 'ENTRADAS' : 'SA√çDAS';
            const itemText = itensParaEnviar.length === 1 ? 'ITEM' : 'ITENS';
            document.getElementById('estoqueLoteResultMessage').innerHTML =
              '<strong style="font-size: 1.2rem;">‚úÖ ' + itensParaEnviar.length + ' ' + itemText + ' INSERIDO(S) COM SUCESSO NO SISTEMA DE ESTOQUE!</strong><br>' +
              '<span style="font-size: 0.95rem;">Opera√ß√£o: ' + tipoOp + '</span>';

            // Mostra tabela com saldos
            mostrarTabelaSaldosLote(result.itensProcessados || itensParaEnviar, operacao);

            // Atualiza cache e autocomplete
            clearClientCache();
            loadDashboardData();
            loadAutocompleteData();

            showMessage('estoqueLoteMessage', '', '');
          } else {
            showMessage('estoqueLoteMessage', result.message || 'Erro ao inserir itens', 'error');
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showMessage('estoqueLoteMessage', 'Erro: ' + error.message, 'error');
        })
        .processMultipleEstoqueItemsWithSaldos(itensParaEnviar);
    }

    // Mostra tabela com os saldos ap√≥s inser√ß√£o do lote (formato similar ao lan√ßamento individual)
    function mostrarTabelaSaldosLote(itens, operacao) {
      const container = document.getElementById('estoqueLoteResultTable');
      const tipoOp = operacao === 'entrada' ? '<span style="color: #28a745; font-weight: bold;">ENTRADA</span>' : '<span style="color: #dc3545; font-weight: bold;">SA√çDA</span>';

      let html = '';

      itens.forEach((item, idx) => {
        const qtd = operacao === 'entrada' ? item.entrada : item.saida;
        const saldoAnterior = item.saldoAnterior !== undefined ? item.saldoAnterior : 0;
        const novoSaldo = item.novoSaldo !== undefined ? item.novoSaldo : 0;

        // Define estilo e HTML do aviso baseado no tipo
        let avisoHtml = '';
        let containerStyle = 'background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;';

        if (item.aviso && item.aviso.includes('DESATUALIZADO')) {
          // AVISO URGENTE - Item desatualizado (+20 dias)
          containerStyle = 'background: #ffebee; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 4px solid #f44336; box-shadow: 0 8px 16px rgba(244, 67, 54, 0.3);';
          avisoHtml = `
            <div style="background: #ffebee; padding: 20px; border-radius: 8px; margin-bottom: 15px; text-align: center; border: 4px solid #f44336;">
              <div style="font-size: 2.5rem; margin-bottom: 10px; animation: pulse 1.5s infinite;">üö®</div>
              <div style="font-size: 1.3rem; margin-bottom: 10px; text-transform: uppercase; color: #c62828; font-weight: bold;">‚ö†Ô∏è ATEN√á√ÉO URGENTE ‚ö†Ô∏è</div>
              <div style="font-size: 1.1rem; margin-bottom: 15px; line-height: 1.5; color: #c62828;">
                <strong>PRODUTO DESATUALIZADO!</strong><br>
                √öltima atualiza√ß√£o h√° mais de 20 dias
              </div>
              <div style="font-size: 1.2rem; background: #d32f2f; color: white; padding: 15px; border-radius: 6px; margin-top: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                ‚ö° A√á√ÉO NECESS√ÅRIA: ATUALIZAR ESTOQUE URGENTE! ‚ö°<br>
                <span style="font-size: 0.9rem; margin-top: 8px; display: block;">
                  Realize uma contagem f√≠sica e registre uma atualiza√ß√£o completa do saldo
                </span>
              </div>
            </div>
          `;
        } else if (item.aviso && item.aviso.includes('ENTRADA')) {
          // AVISO - Entrada de estoque
          containerStyle = 'background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 3px solid #ffc107; box-shadow: 0 4px 8px rgba(255, 193, 7, 0.2);';
          avisoHtml = `
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center; border: 3px solid #ffc107;">
              <div style="font-size: 2rem; margin-bottom: 8px;">üì¶</div>
              <div style="font-size: 1.1rem; margin-bottom: 10px; color: #856404;"><strong>‚ö†Ô∏è ENTRADA DE ESTOQUE REGISTRADA!</strong></div>
              <div style="font-size: 0.95rem; line-height: 1.5; color: #856404;">
                √â necess√°rio atualizar o estoque deste item para evitar furos de estoque.<br>
                <strong>Realize uma contagem f√≠sica e registre uma atualiza√ß√£o completa do saldo.</strong>
              </div>
            </div>
          `;
        }

        html += `
          <div style="${containerStyle}">
            ${avisoHtml}
            <table style="width: 100%; border-collapse: collapse;">
              <tr>
                <td style="padding: 6px; font-weight: bold; width: 35%;">Produto:</td>
                <td style="padding: 6px; font-size: 1.1rem;"><strong>${item.item}</strong></td>
              </tr>
              <tr style="background: #fff;">
                <td style="padding: 6px; font-weight: bold;">Grupo:</td>
                <td style="padding: 6px;">${item.grupo || '-'}</td>
              </tr>
              <tr>
                <td style="padding: 6px; font-weight: bold;">Tipo:</td>
                <td style="padding: 6px;">${tipoOp}</td>
              </tr>
              <tr style="background: #fff;">
                <td style="padding: 6px; font-weight: bold;">Quantidade:</td>
                <td style="padding: 6px; font-size: 1.1rem; font-weight: bold;">${qtd}</td>
              </tr>
            </table>
            <!-- Destaque para os saldos -->
            <div style="margin-top: 10px; padding: 10px; background: linear-gradient(135deg, #e8f5e9, #c8e6c9); border-radius: 6px; border: 2px solid #4caf50;">
              <table style="width: 100%; border-collapse: collapse;">
                <tr>
                  <td style="padding: 6px; font-weight: bold; width: 35%;">Saldo Anterior:</td>
                  <td style="padding: 6px; font-size: 1.1rem;">${saldoAnterior}</td>
                </tr>
                <tr>
                  <td style="padding: 6px; font-weight: bold; font-size: 1rem; color: #2e7d32;">NOVO SALDO:</td>
                  <td style="padding: 6px; font-size: 1.3rem; font-weight: bold; color: #2e7d32;">${novoSaldo}</td>
                </tr>
              </table>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // Volta para o formul√°rio de lote
    function voltarParaLote() {
      document.getElementById('estoqueLoteResultArea').style.display = 'none';
      document.getElementById('estoqueLoteArea').style.display = 'block';
      limparFormLote();
      adicionarItemLote();
    }

    // Handle Inserir Grupo
    function handleInserirGrupo(event) {
      event.preventDefault();

      // Converte para mai√∫scula
      const grupo = document.getElementById('grupoNome').value.toUpperCase().trim();

      if (!grupo) {
        showMessage('grupoMessage', 'Digite o nome do grupo', 'error');
        return false;
      }

      // Verifica se grupo j√° existe
      if (grupoJaExiste(grupo)) {
        showMessage('grupoMessage', 'Este grupo j√° existe! Escolha outro nome.', 'error');
        return false;
      }

      showLoading('Inserindo grupo...');

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            showMessage('grupoMessage', 'Grupo "' + grupo + '" inserido com sucesso!', 'success');
            document.getElementById('grupoForm').reset();
            loadAutocompleteData();
            atualizarListaGrupos(); // Atualiza a lista
          } else {
            showMessage('grupoMessage', result.message || 'Erro ao inserir grupo', 'error');
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showMessage('grupoMessage', 'Erro: ' + error.message, 'error');
        })
        .insertGroup(grupo);

      return false;
    }

    // Verifica se grupo j√° existe na lista de autocomplete
    function grupoJaExiste(grupo) {
      if (!autocompleteData || !autocompleteData.groups) return false;
      const grupoUpper = grupo.toUpperCase().trim();
      return autocompleteData.groups.some(g => g.toUpperCase().trim() === grupoUpper);
    }

    // Valida em tempo real se grupo j√° existe
    function validarGrupoDuplicado() {
      const input = document.getElementById('grupoNome');
      const validation = document.getElementById('grupoValidation');
      const btn = document.getElementById('btnAdicionarGrupo');
      const grupo = input.value.toUpperCase().trim();

      if (!grupo) {
        validation.style.display = 'none';
        btn.disabled = false;
        return;
      }

      if (grupoJaExiste(grupo)) {
        validation.textContent = '‚ö†Ô∏è Este grupo j√° existe!';
        validation.style.display = 'block';
        btn.disabled = true;
        btn.style.opacity = '0.5';
      } else {
        validation.style.display = 'none';
        btn.disabled = false;
        btn.style.opacity = '1';
      }
    }

    // Atualiza a lista de grupos existentes na tela
    function atualizarListaGrupos() {
      const container = document.getElementById('listaGruposExistentes');
      const contador = document.getElementById('totalGrupos');

      if (!autocompleteData || !autocompleteData.groups || autocompleteData.groups.length === 0) {
        container.innerHTML = '<p style="color: #999;">Nenhum grupo cadastrado.</p>';
        contador.textContent = '0';
        return;
      }

      // Ordena alfabeticamente
      const gruposOrdenados = [...autocompleteData.groups].sort();

      contador.textContent = gruposOrdenados.length;

      let html = '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
      gruposOrdenados.forEach(grupo => {
        html += '<span style="background: #e3f2fd; color: #1565c0; padding: 4px 10px; border-radius: 4px; font-size: 0.85rem;">' + grupo + '</span>';
      });
      html += '</div>';

      container.innerHTML = html;
    }

    // ========================================
    // FUN√á√ïES DE BUSCA - Localizar Produto
    // ========================================

    /**
     * Busca R√°pida - Usa √≠ndice em mem√≥ria (INSTANT√ÇNEO)
     * Mostra √∫ltimos 20 registros do item
     */
    function handleBuscaRapida(event) {
      event.preventDefault();

      const item = document.getElementById('localizarItem').value;

      if (!item || item.trim() === '') {
        showMessage('localizarMessage', 'Por favor, informe um item para buscar', 'warning');
        return false;
      }

      // Primeiro atualiza o √≠ndice do servidor (em background)
      refreshHistoryIndexInBackground();

      // Busca no √≠ndice local (instant√¢neo)
      const localHistory = getItemHistoryFromIndex(item);

      if (localHistory) {
        const displayData = formatHistoryForDisplay(localHistory, 20);
        if (displayData && displayData.rows.length > 0) {
          // Mostra resumo do item
          const infoHtml = '<div style="margin-bottom:10px;padding:10px;background:#e3f2fd;border-radius:4px;">' +
            '<strong>üìä Resumo:</strong> ' +
            'Saldo Atual: <strong>' + (localHistory.info.lastStock || '0') + '</strong> | ' +
            '√öltima Atualiza√ß√£o: <strong>' + (localHistory.info.lastDate || '-') + '</strong> | ' +
            'Grupo: <strong>' + (localHistory.info.group || '-') + '</strong>' +
            '<br><small style="color:#666;">‚ö° Busca R√°pida - √öltimos ' + displayData.rows.length + ' registros (cache)</small>' +
            '</div>';

          document.getElementById('localizarTableContainer').innerHTML = infoHtml;
          displayTable('localizarTableContainer', displayData);
          document.getElementById('localizarResults').style.display = 'block';
          document.getElementById('totalResults').textContent = displayData.rows.length + ' (√∫ltimos)';
          showMessage('localizarMessage', '‚ö° ' + displayData.rows.length + ' registros encontrados (instant√¢neo)', 'success');
          return false;
        }
      }

      // Se n√£o encontrou no √≠ndice local, busca no servidor
      showMessage('localizarMessage', 'üîç Item n√£o encontrado no cache, buscando no servidor...', 'info');
      buscarHistoricoCompleto(item);

      return false;
    }

    /**
     * Hist√≥rico Completo - Busca TODOS os registros do servidor
     */
    function handleHistoricoCompleto() {
      const item = document.getElementById('localizarItem').value;

      if (!item || item.trim() === '') {
        showMessage('localizarMessage', 'Por favor, informe um item para buscar', 'warning');
        return;
      }

      buscarHistoricoCompleto(item);
    }

    /**
     * Busca hist√≥rico completo no servidor (todos os registros)
     */
    function buscarHistoricoCompleto(item) {
      showMessage('localizarMessage', 'üìú Buscando hist√≥rico completo no servidor...', 'info');
      document.getElementById('localizarResults').style.display = 'none';

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success && result.data && result.data.rows.length > 0) {
            // Mostra resumo
            const infoHtml = '<div style="margin-bottom:10px;padding:10px;background:#e8f5e9;border-radius:4px;">' +
              '<strong>üìú Hist√≥rico Completo:</strong> ' + result.data.rows.length + ' registros encontrados' +
              '<br><small style="color:#666;">Dados carregados diretamente da planilha</small>' +
              '</div>';

            document.getElementById('localizarTableContainer').innerHTML = infoHtml;
            displayTable('localizarTableContainer', result.data);
            document.getElementById('localizarResults').style.display = 'block';
            document.getElementById('totalResults').textContent = result.data.rows.length;
            showMessage('localizarMessage', '‚úÖ ' + result.data.rows.length + ' registros encontrados (hist√≥rico completo)', 'success');
          } else {
            showMessage('localizarMessage', result.message || 'Nenhum registro encontrado para este item', 'warning');
            document.getElementById('localizarResults').style.display = 'none';
          }
        })
        .withFailureHandler(function(error) {
          showMessage('localizarMessage', 'Erro ao buscar: ' + error.message, 'error');
        })
        .buscarProduto(item, null, null);
    }

    // Show all products (CLIENT-SIDE - INSTANT!)
    function showAllProducts() {
      // Filtra no lado do cliente sem filtro de item (mostra tudo)
      const result = filterEstoqueData('', null, null);

      if (result.success && result.data) {
        displayTable('localizarTableContainer', result.data);
        document.getElementById('localizarResults').style.display = 'block';
        document.getElementById('totalResults').textContent = result.data.rows.length;
      } else {
        showMessage('localizarMessage', result.message || 'Erro ao buscar produtos', 'error');
      }
    }

    // Print results (CLIENT-SIDE - INSTANT!)
    function printResults(filterByDate) {
      const item = document.getElementById('localizarItem').value;

      if (filterByDate) {
        const dataInicio = document.getElementById('printDataInicio').value;
        const dataFim = document.getElementById('printDataFim').value;

        if (!dataInicio || !dataFim) {
          alert('Por favor, selecione o per√≠odo para impress√£o.');
          return;
        }

        // Filtra no lado do cliente com data (INSTANT√ÇNEO!)
        const result = filterEstoqueData(item, dataInicio, dataFim);

        if (result.success && result.data) {
          displayTable('localizarTableContainer', result.data);
          document.getElementById('totalResults').textContent = result.data.rows.length;
          setTimeout(() => window.print(), 500);
        } else {
          showMessage('localizarMessage', 'Nenhum resultado no per√≠odo selecionado', 'warning');
        }
      } else {
        // Imprime tudo que est√° sendo exibido
        setTimeout(() => window.print(), 100);
      }
    }

    // Handle Listagem Estoque (legado - n√£o mais usado)
    function handleListagemEstoque(event) {
      event.preventDefault();

      const formData = {
        group: document.getElementById('listagemGroup').value,
        item: document.getElementById('listagemItem') ? document.getElementById('listagemItem').value : ''
      };

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success && result.data) {
            displayTable('listagemTableContainer', result.data);
            document.getElementById('listagemResults').style.display = 'block';
          } else {
            showMessage('listagemMessage', result.message || 'Nenhum resultado encontrado', 'warning');
          }
        })
        .withFailureHandler(function(error) {
          showMessage('listagemMessage', 'Erro: ' + error.message, 'error');
        })
        .gerarListagemEstoqueWebApp(formData);

      return false;
    }

    // Handle Busca por Grupo - Retorna √∫ltimo lan√ßamento de cada item do grupo
    function handleBuscaPorGrupo() {
      const grupo = document.getElementById('listagemGroup').value;

      if (!grupo) {
        showMessage('listagemMessage', 'Selecione um grupo para buscar', 'warning');
        return;
      }

      // Mostra loading
      showMessage('listagemMessage', 'Buscando itens do grupo...', 'info');
      document.getElementById('listagemResults').style.display = 'none';

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success && result.data) {
            displayTable('listagemTableContainer', result.data);
            document.getElementById('listagemTotal').textContent = result.totalItens || result.data.rows.length;
            document.getElementById('listagemResults').style.display = 'block';
            showMessage('listagemMessage', 'Encontrados ' + (result.totalItens || result.data.rows.length) + ' itens no grupo "' + grupo + '"', 'success');
          } else {
            showMessage('listagemMessage', result.message || 'Nenhum resultado encontrado', 'warning');
            document.getElementById('listagemResults').style.display = 'none';
          }
        })
        .withFailureHandler(function(error) {
          showMessage('listagemMessage', 'Erro: ' + error.message, 'error');
          document.getElementById('listagemResults').style.display = 'none';
        })
        .buscarUltimoLancamentoPorGrupo(grupo);
    }

    // Adicionar novo campo de item na Listagem de Estoque
    function adicionarItemListagem() {
      const container = document.getElementById('listagemItensContainer');
      const newRow = document.createElement('div');
      newRow.className = 'listagem-item-row';
      newRow.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px; align-items: center;';
      newRow.innerHTML = `
        <input type="text" class="listagem-item-input" list="listagemItemDatalist" placeholder="Digite o nome do item..." style="flex: 1; padding: 10px; border-radius: 4px; border: 1px solid #ddd;">
        <button type="button" class="btn-remove-item" onclick="removerItemListagem(this)" style="background: #f44336; color: white; border: none; border-radius: 4px; width: 36px; height: 36px; cursor: pointer; font-size: 1.2rem;" title="Remover item">√ó</button>
      `;
      container.appendChild(newRow);

      // Foca no novo input
      newRow.querySelector('input').focus();
    }

    // Remover campo de item da Listagem de Estoque
    function removerItemListagem(button) {
      const container = document.getElementById('listagemItensContainer');
      const rows = container.querySelectorAll('.listagem-item-row');

      // Mant√©m pelo menos um campo
      if (rows.length <= 1) {
        // Apenas limpa o campo em vez de remover
        rows[0].querySelector('input').value = '';
        return;
      }

      // Remove a linha do bot√£o clicado
      button.closest('.listagem-item-row').remove();
    }

    // Handle Busca por Lista de Itens - Retorna √∫ltimo lan√ßamento de cada item da lista
    function handleBuscaPorListaItens() {
      // Coleta todos os valores dos inputs din√¢micos
      const inputs = document.querySelectorAll('#listagemItensContainer .listagem-item-input');
      const itens = [];

      inputs.forEach(input => {
        const valor = input.value.trim();
        if (valor) {
          itens.push(valor);
        }
      });

      if (itens.length === 0) {
        showMessage('listagemMessage', 'Selecione pelo menos um item para buscar', 'warning');
        return;
      }

      // Junta os itens em uma string separada por v√≠rgula
      const listaItens = itens.join(',');

      // Mostra loading
      showMessage('listagemMessage', 'Buscando ' + itens.length + ' item(ns)...', 'info');
      document.getElementById('listagemResults').style.display = 'none';

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success && result.data) {
            displayTable('listagemTableContainer', result.data);
            document.getElementById('listagemTotal').textContent = result.totalItens || result.data.rows.length;
            document.getElementById('listagemResults').style.display = 'block';

            let msg = 'Encontrados ' + (result.totalItens || result.data.rows.length) + ' itens';

            // Mostra itens n√£o encontrados, se houver
            if (result.itensNaoEncontrados && result.itensNaoEncontrados.length > 0) {
              msg += '. N√£o encontrados: ' + result.itensNaoEncontrados.join(', ');
              showMessage('listagemMessage', msg, 'warning');
            } else {
              showMessage('listagemMessage', msg, 'success');
            }
          } else {
            showMessage('listagemMessage', result.message || 'Nenhum resultado encontrado', 'warning');
            document.getElementById('listagemResults').style.display = 'none';
          }
        })
        .withFailureHandler(function(error) {
          showMessage('listagemMessage', 'Erro: ' + error.message, 'error');
          document.getElementById('listagemResults').style.display = 'none';
        })
        .buscarUltimoLancamentoPorItens(listaItens);
    }

    // Imprimir Listagem de Estoque
    function printListagem() {
      const resultsDiv = document.getElementById('listagemResults');
      if (!resultsDiv || resultsDiv.style.display === 'none') {
        alert('Nenhum resultado para imprimir');
        return;
      }

      const printWindow = window.open('', '_blank');
      const tableHTML = document.getElementById('listagemTableContainer').innerHTML;

      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Listagem de Estoque</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h1 { text-align: center; margin-bottom: 20px; }
            table { width: 100%; border-collapse: collapse; font-size: 11px; }
            th, td { border: 1px solid #333; padding: 5px 8px; text-align: left; }
            th { background-color: #4a6da7; color: white; }
            tr:nth-child(even) { background-color: #f2f2f2; }
            .row-red { background-color: #ffcccc !important; }
            .row-yellow { background-color: #ffffcc !important; }
            .info { text-align: center; margin-bottom: 10px; color: #666; }
            @media print {
              body { padding: 0; }
              table { font-size: 9px; }
            }
          </style>
        </head>
        <body>
          <h1>Listagem de Estoque</h1>
          <p class="info">Total: ${document.getElementById('listagemTotal').textContent} itens - Gerado em: ${new Date().toLocaleString('pt-BR')}</p>
          ${tableHTML}
        </body>
        </html>
      `);

      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => printWindow.print(), 500);
    }

    // Handle Relat√≥rio Estoque
    function handleRelatorioEstoque(event) {
      event.preventDefault();

      const dataInicio = document.getElementById('relatorioDataInicio').value;
      const dataFim = document.getElementById('relatorioDataFim').value;

      showMessage('relatorioMessage', 'Buscando lan√ßamentos...', 'info');
      document.getElementById('relatorioResults').style.display = 'none';

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success && result.data) {
            displayTable('relatorioTableContainer', result.data);
            document.getElementById('relatorioTotal').textContent = result.data.rows.length;
            document.getElementById('relatorioResults').style.display = 'block';
            showMessage('relatorioMessage', 'Encontrados ' + result.data.rows.length + ' lan√ßamentos no per√≠odo', 'success');
          } else {
            showMessage('relatorioMessage', result.message || 'Nenhum resultado encontrado', 'warning');
          }
        })
        .withFailureHandler(function(error) {
          showMessage('relatorioMessage', 'Erro: ' + error.message, 'error');
        })
        .gerarRelatorioEstoqueWebApp(dataInicio, dataFim);

      return false;
    }

    // Imprimir Relat√≥rio de Estoque
    function printRelatorio() {
      const resultsDiv = document.getElementById('relatorioResults');
      if (!resultsDiv || resultsDiv.style.display === 'none') {
        alert('Nenhum resultado para imprimir');
        return;
      }
      const dataInicio = document.getElementById('relatorioDataInicio').value;
      const dataFim = document.getElementById('relatorioDataFim').value;
      const printWindow = window.open('', '_blank');
      const tableHTML = document.getElementById('relatorioTableContainer').innerHTML;
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Relat√≥rio de Estoque</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h1 { text-align: center; margin-bottom: 20px; }
            table { width: 100%; border-collapse: collapse; font-size: 11px; }
            th, td { border: 1px solid #333; padding: 5px 8px; text-align: left; }
            th { background-color: #4a6da7; color: white; }
            tr:nth-child(even) { background-color: #f2f2f2; }
            .row-red { background-color: #ffcccc !important; }
            .row-yellow { background-color: #ffffcc !important; }
            .info { text-align: center; margin-bottom: 10px; color: #666; }
          </style>
        </head>
        <body>
          <h1>Relat√≥rio de Estoque</h1>
          <p class="info">Per√≠odo: ${dataInicio} a ${dataFim} | Total: ${document.getElementById('relatorioTotal').textContent} lan√ßamentos | Gerado em: ${new Date().toLocaleString('pt-BR')}</p>
          ${tableHTML}
        </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => printWindow.print(), 500);
    }

    // Handle Relat√≥rio por Grupo (mantido para compatibilidade)
    function handleRelatorioPorGrupo(event) {
      event.preventDefault();

      const grupo = document.getElementById('relatorioGrupoSelect').value;

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success && result.data) {
            displayTable('relatorioGrupoTableContainer', result.data);
            document.getElementById('relatorioGrupoResults').style.display = 'block';
          } else {
            showMessage('relatorioGrupoMessage', result.message || 'Nenhum resultado encontrado', 'warning');
          }
        })
        .withFailureHandler(function(error) {
          showMessage('relatorioGrupoMessage', 'Erro: ' + error.message, 'error');
        })
        .gerarRelatorioPorGrupoWebApp(grupo);

      return false;
    }

    // Handle Estoque por Per√≠odo
    function handleEstoquePorPeriodo(event) {
      event.preventDefault();

      const dataInicio = document.getElementById('periodoDataInicio').value;
      const dataFim = document.getElementById('periodoDataFim').value;

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showMessage('estoquePeriodoMessage', 'Filtro aplicado com sucesso! Verifique a planilha.', 'success');
          } else {
            showMessage('estoquePeriodoMessage', result.message || 'Erro ao filtrar', 'error');
          }
        })
        .withFailureHandler(function(error) {
          showMessage('estoquePeriodoMessage', 'Erro: ' + error.message, 'error');
        })
        .filtrarEstoquePorPeriodo(dataInicio, dataFim);

      return false;
    }

    // ========================================
    // ESTOQUE 3 MESES - Fun√ß√µes
    // ========================================

    // Adicionar campo de item no Estoque 3 Meses
    function adicionarItemEstoque3M() {
      const container = document.getElementById('estoque3MesesItensContainer');
      const newRow = document.createElement('div');
      newRow.className = 'estoque3m-item-row';
      newRow.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px; align-items: center;';
      newRow.innerHTML = `
        <input type="text" class="estoque3m-item-input" list="estoque3MesesItemDatalist" placeholder="Digite o nome do item..." style="flex: 1; padding: 10px; border-radius: 4px; border: 1px solid #ddd;">
        <button type="button" onclick="removerItemEstoque3M(this)" style="background: #f44336; color: white; border: none; border-radius: 4px; width: 36px; height: 36px; cursor: pointer; font-size: 1.2rem;" title="Remover item">√ó</button>
      `;
      container.appendChild(newRow);
      newRow.querySelector('input').focus();
    }

    // Remover campo de item do Estoque 3 Meses
    function removerItemEstoque3M(button) {
      const container = document.getElementById('estoque3MesesItensContainer');
      const rows = container.querySelectorAll('.estoque3m-item-row');
      if (rows.length <= 1) {
        rows[0].querySelector('input').value = '';
        return;
      }
      button.closest('.estoque3m-item-row').remove();
    }

    // Handle Estoque 3 Meses - Calcula total de sa√≠das por item
    function handleEstoque3Meses() {
      const inputs = document.querySelectorAll('#estoque3MesesItensContainer .estoque3m-item-input');
      const itens = [];
      inputs.forEach(input => {
        const valor = input.value.trim();
        if (valor) itens.push(valor);
      });

      if (itens.length === 0) {
        showMessage('estoque3MesesMessage', 'Selecione pelo menos um item', 'warning');
        return;
      }

      showMessage('estoque3MesesMessage', 'Calculando sa√≠das dos √∫ltimos 3 meses...', 'info');
      document.getElementById('estoque3MesesResults').style.display = 'none';

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success && result.data) {
            displayTable('estoque3MesesTableContainer', result.data);
            document.getElementById('estoque3MesesTotal').textContent = result.totalItens || result.data.rows.length;
            document.getElementById('estoque3MesesResults').style.display = 'block';

            let msg = 'Calculado para ' + (result.totalItens || result.data.rows.length) + ' itens';
            if (result.itensNaoEncontrados && result.itensNaoEncontrados.length > 0) {
              msg += '. N√£o encontrados: ' + result.itensNaoEncontrados.join(', ');
              showMessage('estoque3MesesMessage', msg, 'warning');
            } else {
              showMessage('estoque3MesesMessage', msg, 'success');
            }
          } else {
            showMessage('estoque3MesesMessage', result.message || 'Nenhum resultado encontrado', 'warning');
          }
        })
        .withFailureHandler(function(error) {
          showMessage('estoque3MesesMessage', 'Erro: ' + error.message, 'error');
        })
        .calcularEstoque3Meses(itens.join(','));
    }

    // Imprimir Estoque 3 Meses
    function printEstoque3Meses() {
      const resultsDiv = document.getElementById('estoque3MesesResults');
      if (!resultsDiv || resultsDiv.style.display === 'none') {
        alert('Nenhum resultado para imprimir');
        return;
      }
      const printWindow = window.open('', '_blank');
      const tableHTML = document.getElementById('estoque3MesesTableContainer').innerHTML;
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Consumo em 3 Meses - Sa√≠das</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h1 { text-align: center; margin-bottom: 20px; }
            table { width: 100%; border-collapse: collapse; font-size: 11px; }
            th, td { border: 1px solid #333; padding: 5px 8px; text-align: left; }
            th { background-color: #e65100; color: white; }
            tr:nth-child(even) { background-color: #f2f2f2; }
            .info { text-align: center; margin-bottom: 10px; color: #666; }
          </style>
        </head>
        <body>
          <h1>Total de Sa√≠das - √öltimos 3 Meses</h1>
          <p class="info">Total: ${document.getElementById('estoque3MesesTotal').textContent} itens - Gerado em: ${new Date().toLocaleString('pt-BR')}</p>
          ${tableHTML}
        </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => printWindow.print(), 500);
    }

    // ========================================
    // CORES DESATUALIZADAS - Fun√ß√µes
    // ========================================

    // Handle Cores Desatualizadas - 15 dias sem ATUALIZA√á√ÉO
    function handleCoresDesatualizadas() {
      showMessage('coresMessage', 'Buscando cores desatualizadas...', 'info');
      document.getElementById('coresResults').style.display = 'none';

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success && result.data) {
            displayTable('coresTableContainer', result.data);
            document.getElementById('coresTotal').textContent = result.totalItens || result.data.rows.length;
            document.getElementById('coresResults').style.display = 'block';
            showMessage('coresMessage', 'Encontrados ' + (result.totalItens || result.data.rows.length) + ' itens desatualizados', 'success');
          } else {
            showMessage('coresMessage', result.message || 'Nenhum item desatualizado encontrado', 'success');
          }
        })
        .withFailureHandler(function(error) {
          showMessage('coresMessage', 'Erro: ' + error.message, 'error');
        })
        .buscarCoresDesatualizadas();
    }

    // Imprimir Cores Desatualizadas
    function printCores() {
      const resultsDiv = document.getElementById('coresResults');
      if (!resultsDiv || resultsDiv.style.display === 'none') {
        alert('Nenhum resultado para imprimir');
        return;
      }
      const printWindow = window.open('', '_blank');
      const tableHTML = document.getElementById('coresTableContainer').innerHTML;
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Cores Desatualizadas</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h1 { text-align: center; margin-bottom: 20px; }
            table { width: 100%; border-collapse: collapse; font-size: 11px; }
            th, td { border: 1px solid #333; padding: 5px 8px; text-align: left; }
            th { background-color: #7b1fa2; color: white; }
            tr:nth-child(even) { background-color: #f2f2f2; }
            .info { text-align: center; margin-bottom: 10px; color: #666; }
          </style>
        </head>
        <body>
          <h1>Cores Desatualizadas (Mais de 15 dias)</h1>
          <p class="info">Total: ${document.getElementById('coresTotal').textContent} itens - Gerado em: ${new Date().toLocaleString('pt-BR')}</p>
          ${tableHTML}
        </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => printWindow.print(), 500);
    }

    // ========================================
    // APAGAR √öLTIMA LINHA - Fun√ß√µes
    // ========================================

    // Carregar √∫ltimas 20 entradas
    function carregarUltimasEntradas() {
      showMessage('apagarLinhaMessage', 'Carregando √∫ltimas entradas...', 'info');
      document.getElementById('ultimasEntradasArea').style.display = 'none';

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success && result.data) {
            // Exibe informa√ß√£o da √∫ltima entrada
            const ultimaRow = result.data.rows[0];
            if (ultimaRow) {
              document.getElementById('ultimaEntradaInfo').innerHTML = `
                <strong>√öltima entrada:</strong><br>
                <strong>Item:</strong> ${ultimaRow[1] || '-'} |
                <strong>Grupo:</strong> ${ultimaRow[0] || '-'} |
                <strong>Data:</strong> ${ultimaRow[3] || '-'} |
                <strong>Entrada:</strong> ${ultimaRow[7] || '0'} |
                <strong>Sa√≠da:</strong> ${ultimaRow[8] || '0'} |
                <strong>Saldo:</strong> ${ultimaRow[9] || '-'}
              `;
            }
            displayTable('ultimasEntradasTableContainer', result.data);
            document.getElementById('ultimasEntradasArea').style.display = 'block';
            showMessage('apagarLinhaMessage', '', '');
          } else {
            showMessage('apagarLinhaMessage', result.message || 'Nenhuma entrada encontrada', 'warning');
          }
        })
        .withFailureHandler(function(error) {
          showMessage('apagarLinhaMessage', 'Erro: ' + error.message, 'error');
        })
        .getUltimas20Entradas();
    }

    // Confirmar exclus√£o da √∫ltima linha
    function confirmarApagarLinha() {
      if (!confirm('‚ö†Ô∏è ATEN√á√ÉO FINAL!\n\nVoc√™ est√° prestes a APAGAR PERMANENTEMENTE a √∫ltima entrada.\n\nEsta a√ß√£o N√ÉO PODE SER DESFEITA!\n\nTem certeza que deseja continuar?')) return;

      showMessage('apagarLinhaMessage', 'Apagando √∫ltima entrada...', 'info');

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showMessage('apagarLinhaMessage', '√öltima entrada apagada com sucesso!', 'success');
            document.getElementById('ultimasEntradasArea').style.display = 'none';
            loadDashboardData();
            loadAutocompleteData();
            // Recarrega a lista ap√≥s 1 segundo
            setTimeout(carregarUltimasEntradas, 1000);
          } else {
            showMessage('apagarLinhaMessage', result.message || 'Erro ao apagar', 'error');
          }
        })
        .withFailureHandler(function(error) {
          showMessage('apagarLinhaMessage', 'Erro: ' + error.message, 'error');
        })
        .apagarUltimaLinhaWebApp();
    }

    // Display table from data with row colors
    function displayTable(containerId, data) {
      const container = document.getElementById(containerId);

      if (!data || !data.headers || !data.rows || data.rows.length === 0) {
        container.innerHTML = '<p>Nenhum resultado encontrado.</p>';
        return;
      }

      let html = '<table><thead><tr>';
      data.headers.forEach(header => {
        html += '<th>' + header + '</th>';
      });
      html += '</tr></thead><tbody>';

      data.rows.forEach((row, index) => {
        // Determina a classe CSS baseada na cor de fundo
        let rowClass = '';
        if (data.colors && data.colors[index]) {
          const color = data.colors[index].toLowerCase();
          if (color === '#ff0000' || color === 'red' || color === '#f00') {
            rowClass = ' class="row-red"';
          } else if (color === '#ffff00' || color === 'yellow' || color === '#ff0') {
            rowClass = ' class="row-yellow"';
          }
        }

        html += '<tr' + rowClass + '>';
        row.forEach(cell => {
          html += '<td>' + (cell !== null && cell !== undefined ? cell : '') + '</td>';
        });
        html += '</tr>';
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }
  </script>

  <!-- Modal de Resultado Inserir Estoque -->
  <!-- Loading Overlay -->
  <div id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text" id="loadingText">Processando...</div>
      <div class="loading-subtext">Aguarde, n√£o feche esta janela</div>

      <!-- Lista de √öltimos Lan√ßamentos -->
      <div class="ultimos-lancamentos" id="ultimosLancamentos">
        <h4>üìã √öltimos 20 Lan√ßamentos</h4>
        <div class="lancamentos-list" id="lancamentosList">
          <div class="loading-lancamentos">Carregando lan√ßamentos...</div>
        </div>
      </div>
    </div>
  </div>

  <div id="modalResultadoEstoque" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header" style="background: #28a745; color: white;">
        <h3>‚úì Lan√ßamento Realizado!</h3>
      </div>
      <div class="modal-body">
        <!-- Mensagem de Sucesso -->
        <div style="background: #d4edda; border: 2px solid #28a745; color: #155724; padding: 12px; border-radius: 8px; margin-bottom: 15px; text-align: center; font-weight: bold; font-size: 1.1rem;">
          ‚úÖ ITEM INSERIDO COM SUCESSO NO SISTEMA DE ESTOQUE!
        </div>
        <div id="avisoItemNovoModal" class="novo-item-warning" style="display: none;">
          <strong>‚ö†Ô∏è ATEN√á√ÉO:</strong> Este √© um item <strong>NOVO</strong> que foi cadastrado agora!
        </div>
        <!-- Aviso de Produto Desatualizado ou Entrada -->
        <div id="avisoStatusProduto" style="display: none; margin-bottom: 15px; padding: 20px; border-radius: 8px; font-weight: bold; text-align: center;"></div>
        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px; font-weight: bold; width: 40%;">Produto:</td>
              <td style="padding: 8px;" id="resultProduto"></td>
            </tr>
            <tr style="background: #fff;">
              <td style="padding: 8px; font-weight: bold;">Grupo:</td>
              <td style="padding: 8px;" id="resultGrupo"></td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold;">Tipo:</td>
              <td style="padding: 8px;" id="resultTipo"></td>
            </tr>
            <tr style="background: #fff;">
              <td style="padding: 8px; font-weight: bold;">Quantidade:</td>
              <td style="padding: 8px; font-size: 1.1rem; font-weight: bold;" id="resultQtd"></td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold;">NF:</td>
              <td style="padding: 8px;" id="resultNF"></td>
            </tr>
            <tr style="background: #fff;">
              <td style="padding: 8px; font-weight: bold;">Observa√ß√£o:</td>
              <td style="padding: 8px;" id="resultObs"></td>
            </tr>
          </table>
        </div>
        <!-- Destaque para os saldos -->
        <div style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #e8f5e9, #c8e6c9); border-radius: 8px; border: 2px solid #4caf50;">
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px; font-weight: bold; width: 40%;">Saldo Anterior:</td>
              <td style="padding: 8px; font-size: 1.2rem;" id="resultSaldoAnterior"></td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; font-size: 1.1rem; color: #2e7d32;">NOVO SALDO:</td>
              <td style="padding: 8px; font-size: 1.5rem; font-weight: bold; color: #2e7d32;" id="resultNovoSaldo"></td>
            </tr>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" onclick="fecharModalResultado()" style="width: 100%;">
          ‚úì OK - Inserir Outro Item
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de Confirma√ß√£o NF -->
  <div id="modalConfirmacaoNF" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üìã Confirme os Itens da NF</h3>
        <button class="modal-close" onclick="fecharModalConfirmacao()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="avisoItensNovos" class="novo-item-warning" style="display: none;">
          <strong>‚ö†Ô∏è ATEN√á√ÉO:</strong> Existem itens <strong>NOVOS</strong> que n√£o existem na base de dados!
          <br>Verifique se digitou corretamente para evitar problemas futuros.
          <br>Itens novos est√£o destacados em <span style="background: #fff3cd; padding: 2px 6px;">amarelo</span>.
        </div>
        <div id="infoNFModal" style="background: #e3f2fd; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
          <!-- Info da NF ser√° inserida aqui -->
        </div>
        <div class="confirm-header-row">
          <span>#</span>
          <span>Item</span>
          <span>Grupo</span>
          <span>Pre√ßo</span>
          <span>Lote</span>
          <span>Entrada</span>
          <span>A√ß√£o</span>
        </div>
        <div id="listaItensConfirmacao">
          <!-- Itens ser√£o listados aqui -->
        </div>
        <div id="contadorConfirmacao" style="text-align: center; margin-top: 15px; padding: 10px; background: #f5f5f5; border-radius: 4px;">
          Confirmados: <strong><span id="totalConfirmados">0</span></strong> de <strong><span id="totalItensNF">0</span></strong>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-warning" onclick="voltarParaEdicao()">‚Ü© Voltar e Ajustar</button>
        <button type="button" id="btnConfirmarInsercaoFinal" class="btn btn-success" onclick="confirmarInsercaoFinal()" disabled>
          ‚úì Confirmar e Inserir
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de Confirma√ß√£o Lote -->
  <div id="modalConfirmacaoLote" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üì¶ Confirme a Movimenta√ß√£o em Lote</h3>
        <button class="modal-close" onclick="fecharModalConfirmacaoLote()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="avisoItensNovosLote" class="novo-item-warning" style="display: none;">
          <strong>‚ö†Ô∏è ATEN√á√ÉO:</strong> Existem itens <strong>NOVOS</strong> que n√£o existem na base de dados!
          <br>Verifique se digitou corretamente para evitar problemas futuros.
          <br>Itens novos est√£o destacados em <span style="background: #fff3cd; padding: 2px 6px;">amarelo</span>.
        </div>
        <div id="infoLoteModal" style="background: #e8f5e9; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
          <!-- Info do Lote ser√° inserida aqui -->
        </div>
        <div class="confirm-header-row-lote">
          <span>#</span>
          <span>Produto</span>
          <span>Quantidade</span>
          <span>Saldo Atual</span>
          <span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px;">Saldo Final</span>
          <span>A√ß√£o</span>
        </div>
        <div id="listaItensConfirmacaoLote">
          <!-- Itens ser√£o listados aqui -->
        </div>
        <div id="contadorConfirmacaoLote" style="text-align: center; margin-top: 15px; padding: 10px; background: #f5f5f5; border-radius: 4px;">
          Confirmados: <strong><span id="totalConfirmadosLote">0</span></strong> de <strong><span id="totalItensLote">0</span></strong>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-warning" onclick="voltarParaEdicaoLote()">‚Ü© Voltar e Ajustar</button>
        <button type="button" id="btnConfirmarInsercaoFinalLote" class="btn btn-success" onclick="confirmarInsercaoFinalLote()" disabled>
          ‚úì Confirmar e Inserir
        </button>
      </div>
    </div>
  </div>
</body>
</html>
